<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquivo Central // Museu do Videojogo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- FONTES ATUALIZADAS para Inter, Roboto e Press Start 2P (removido VT323) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto:wght@400&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            /* === PALETA DE CORES E VARIÁVEIS GLOBAIS (do seu index.html) === */
            --color-primary: #D4A356; /* Dourado Sofisticado */
            --color-primary-hover: #B88A40;
            --color-dark: #171A21; /* Carvão Profundo */
            --color-accent-blue: #355070; /* Azul Museu */
            --color-dark-blue: #1a2533;
            --color-background-light: #F7F6F3; /* Marfim/Off-white */
            --color-background-gray: #EAE8E4; /* Cinza Claro Quente */
            --color-text-dark: #2C2C2C;
            --color-text-light: #6B6B6B;
            --color-text-on-dark: #EAE8E4;
            --border-color: rgba(0,0,0,0.1);
            --shadow-elegant: 0 4px 20px rgba(0, 0, 0, 0.08);

            /* Mapeamento para os nomes antigos para facilitar a transição */
            --bg-main: var(--color-background-light);
            --terminal-text: var(--color-text-dark);
            --accent-cyan: var(--color-primary); /* Dourado como acento principal */
            --accent-magenta: var(--color-accent-blue); /* Azul Museu para títulos */
            --card-bg: #ffffff; /* Manter cards brancos como no site principal */
            --card-border: var(--border-color);
            --text-dim: var(--color-text-light);
            --header-bg: var(--color-dark); /* Header escuro, como no site principal */
        }

        /* --- ESTILOS GLOBAIS E TEMA CRT --- */
        body {
            font-family: 'Roboto', sans-serif; /* Fonte ATUALIZADA para Roboto */
            background-color: var(--bg-main); /* Cor de fundo ATUALIZADA para Marfim */
            color: var(--color-text-dark); /* Cor do texto ATUALIZADA para Escura */
            font-size: 16px; /* Tamanho de fonte padrão */
        }

        /* FONTES ATUALIZADAS */
        p {
            font-family: 'Roboto', sans-serif;
        }
        h1, h2, h3, #searchInput, .status-indicator {
            font-family: 'Inter', sans-serif; /* Usar Inter para UI e Títulos */
        }

        /* Efeito de Scanlines e Brilho (CRT Overlay) REMOVIDO */
        /*
        body::before {
            ...
        }
        @keyframes flicker {
            ...
        }
        */

        /* Classe para a fonte de jogo 8-bit (Títulos e UI) */
        .pixel-font {
            font-family: 'Press Start 2P', monospace; /* Mantida (igual ao .section-title) */
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-size: 12px; /* Press Start 2P funciona melhor em tamanhos menores */
        }

        /* Efeito de brilho néon para texto (Removido brilho, apenas cor) */
        .text-glow-cyan {
            color: var(--accent-cyan); /* Dourado */
            text-shadow: none;
        }
        .text-glow-terminal {
            color: var(--terminal-text); /* Texto Escuro */
            text-shadow: none;
        }
        .text-glow-magenta {
            color: var(--accent-magenta); /* Azul Museu */
            text-shadow: none;
        }

        /* --- HEADER E NAVEGAÇÃO (Alinhado com o site principal) --- */
        #header-logo {
            height: 80px;
            width: auto;
            filter: none; /* REMOVIDO filtro azul (logo já é branco) */
        }

        .form-input {
            background-color: #333; /* Fundo escuro para input */
            border: 1px solid #555;
            color: var(--color-text-on-dark); /* Texto claro */
            padding: 0.5rem 0.75rem;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary); /* Dourado */
            box-shadow: 0 0 5px rgba(212, 163, 86, 0.5); /* Sombra Dourada */
        }

         #autocomplete-results {
            background-color: var(--header-bg); /* Fundo escuro */
            border: 1px solid #555;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .autocomplete-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background-color: #333;
            color: var(--color-primary); /* Dourado */
        }

        /* --- MONITOR DE STATUS (Substitui o HUD) --- */
        #status-monitor {
            border: 1px solid var(--border-color);
            background-color: var(--color-background-gray); /* Cinza Quente (do site) */
            padding: 1rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-elegant); /* Sombra Elegante (do site) */
        }

        .progress-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border: 1px solid var(--card-border);
            overflow: hidden;
        }
        .progress-bar {
            height: 16px;
            background-color: var(--color-primary); /* Dourado */
            width: 0%;
            transition: width 0.6s ease;
            box-shadow: 0 0 10px rgba(212, 163, 86, 0.5); /* Sombra Dourada */
        }


        /* --- SEÇÕES DA LINHA DO TEMPO (ERAS) --- */
        .era-section {
            margin-bottom: 4rem;
        }
        .era-header {
            border-bottom: 2px solid var(--color-primary); /* Dourado */
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: none;
            /* Fixa o cabeçalho da Era ao topo durante a navegação */
            position: sticky;
            top: 80px; /* Altura do header (h-20 = 80px) */
            background-color: var(--bg-main); /* Fundo Marfim */
            z-index: 30;
            padding-top: 1rem;
        }

        /* --- ESTILOS DOS CARTÕES (Entradas do Banco de Dados) --- */
        .gallery-card {
            background-color: var(--card-bg); /* Branco */
            border: 1px solid var(--card-border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            position: relative;
            border-radius: 4px 4px 10px 10px;
            box-shadow: var(--shadow-elegant); /* Sombra Elegante (do site) */
        }
        
        .gallery-card:hover {
            transform: translateY(-5px);
            border-color: var(--color-primary); /* Dourado */
            box-shadow: 0 12px 30px rgba(0,0,0,0.12); /* Sombra do site principal */
            z-index: 20;
        }

        /* Estado "Não Descoberto" - Menos saturado e mais escuro */
        .gallery-card.undiscovered {
            filter: grayscale(80%) opacity(0.7);
        }

        /* Estado "Descoberto" - Cores normais e destaque */
        .gallery-card.discovered {
            filter: none;
            border-color: var(--color-accent-blue); /* Azul Museu */
        }

        /* Indicador de Status no Cartão (Visual) */
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 3px;
            z-index: 10;
        }
        .undiscovered .status-indicator {
            background-color: #6c757d;
            color: #ffffff;
        }
        .discovered .status-indicator {
            background-color: var(--color-accent-blue); /* Azul Museu */
            color: #ffffff;
            font-weight: bold;
        }

        .card-image-container {
            padding: 1rem;
            background-color: #f8f9fa; /* Um cinza bem claro para a imagem */
            border-bottom: 1px solid var(--card-border);
        }

        /* Estilo para o link "Acessar Registro" (imitando btn-primary) */
        .item-link {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem; /* text-xs */
            padding: 0.6rem; /* py-2ish */
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
            border-radius: 0.25rem;
            transition: all 0.3s ease;
        }
        .item-link:hover {
            background-color: var(--color-primary);
            color: var(--color-dark); /* Texto escuro no botão dourado */
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(212, 163, 86, 0.3);
        }

    </style>
</head>
<body class="antialiased">

    <header class="sticky top-0 z-50 shadow-lg" style="background-color: var(--header-bg);">
        <nav class="container mx-auto px-4 sm:px-6 h-20 flex justify-between items-center gap-4">
            <a href="index.html" class="flex-shrink-0">
                <img id="header-logo" src="imagens/LOGO MUSEU DO VIDEOGAME LETRAS BRANCAS (1).png" alt="Logo Museu do Videogame">
            </a>
            
            <div class="flex-grow flex justify-center items-center gap-4 px-2 sm:px-4">
                <div id="search-container" class="relative w-full max-w-lg">
                    <input type="text" id="searchInput" placeholder=">_ PESQUISAR ARQUIVO..." class="form-input w-full py-2 pl-10 pr-4" style="font-family: 'Inter', sans-serif; font-size: 0.875rem;">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">
                        <i class="fa-solid fa-search"></i>
                    </span>
                    <div id="autocomplete-results" class="absolute left-0 right-0 top-full mt-2 z-50 hidden"></div>
                </div>
            </div>

            <a href="index.html" class="hidden sm:flex items-center gap-2 text-sm hover:text-red-700 pixel-font" style="color: var(--color-text-on-dark); opacity: 0.8;">
                <i class="fa-solid fa-sign-out-alt"></i>
                <span>LOGOUT</span>
            </a>
        </nav>
    </header>

    <main class="pt-8 pb-16">
        
        <div class="container mx-auto px-4">
            
            <div class="text-center mb-12">
                <h1 class="text-3xl md:text-4xl pixel-font text-glow-cyan mb-4">::: ARQUIVO CENTRAL :::</h1>
                <p class="text-xl">>_ Acesso à Linha do Tempo Iniciado. Explore as Eras.</p>
            </div>

            <section id="status-monitor">
                <div class="flex justify-between items-center">
                    <div class="pixel-font text-sm text-glow-terminal">PROGRESSO GLOBAL DE DESCOBERTA</div>
                    <div id="hud-discovered" class="pixel-font text-sm" style="color: var(--color-text-light);">0 / ? ITENS</div>
                </div>
                <div class="progress-bar-container mt-4">
                    <div id="global-progress-bar" class="progress-bar"></div>
                </div>
            </section>

            
            <div id="gallery-container">
                <div id="gallery-loader" class="col-span-full text-center py-20">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-500"></i>
                    <p class="mt-4 text-xl text-gray-500">>_ A carregar Linha do Tempo...</p>
                </div>

                <div id="search-results-container" class="hidden">
                    <div class="era-header">
                         <h2 class="text-2xl pixel-font text-glow-cyan">Resultados da Pesquisa</h2>
                 <button id="clear-search-btn" class="pixel-font text-sm text-red-600 hover:text-red-700">[LIMPAR BUSCA]</button>
                    </div>
                    <div id="search-results-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
                </div>
            </div>

        </div>
    </main>
    
    <footer class="py-8 mt-16" style="background-color: var(--color-dark); color: var(--color-text-on-dark);">
        <div class="container mx-auto text-center opacity-80 text-sm pixel-font">
            <p>&copy; 2025 MUSEU ITINERANTE DO VIDEOJOGO. TERMINAL V1.9.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase (Mantida)
        const firebaseConfig = {
            apiKey: "AIzaSyCvngtKFRtfIJw-8ISyi5iZSvJq3jicP_4",
            authDomain: "museu-cca6d.firebaseapp.com",
            projectId: "museu-cca6d",
            storageBucket: "museu-cca6d.firebasestorage.app",
            messagingSenderId: "555107674356",
            appId: "1:555107674356:web:f38d1703d35831f7ad16a1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'museu-cca6d';

        // --- STATE MANAGEMENT (Simplificado) ---
        const state = {
            items: [],
            groupedItems: {}, // Armazena itens agrupados por década
            playerData: {
                // Focamos apenas na descoberta (Sem XP/Level)
                discoveredItems: new Set() 
            },
            totalItemsCount: 0,
            isSearching: false
        };

        // --- DOM ELEMENTS ---
        const galleryContainer = document.getElementById('gallery-container');
        const galleryLoader = document.getElementById('gallery-loader');
        const searchInput = document.getElementById('searchInput');
        const autocompleteResults = document.getElementById('autocomplete-results');
        const searchResultsContainer = document.getElementById('search-results-container');
        const searchResultsGrid = document.getElementById('search-results-grid');
        const clearSearchBtn = document.getElementById('clear-search-btn');

        // Elementos do Monitor de Status
        const hudDiscovered = document.getElementById('hud-discovered');
        const globalProgressBar = document.getElementById('global-progress-bar');

        // --- GAMIFICATION LOGIC (Foco em Descoberta) ---

        // Carrega os dados do jogador (Simplificado)
        function loadPlayerData() {
            // Usamos uma chave de armazenamento específica para esta versão imersiva
            const savedData = localStorage.getItem('museu_archive_discovery_v6');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    state.playerData.discoveredItems = new Set(parsedData.discoveredItems || []);
                } catch (e) {
                    console.error("Erro ao carregar dados do jogador:", e);
                }
            }
            updateStatusMonitor();
        }

        // Guarda os dados do jogador
        function savePlayerData() {
            const dataToSave = {
                discoveredItems: Array.from(state.playerData.discoveredItems)
            };
            localStorage.setItem('museu_archive_discovery_v6', JSON.stringify(dataToSave));
        }

        // Atualiza a interface do Monitor de Status
        function updateStatusMonitor() {
            const totalDisplay = state.totalItemsCount > 0 ? state.totalItemsCount : '?';
            const discoveredCount = state.playerData.discoveredItems.size;
            hudDiscovered.textContent = `${discoveredCount} / ${totalDisplay} ITENS`;
            
            let progress = 0;
            if (state.totalItemsCount > 0) {
                progress = (discoveredCount / state.totalItemsCount) * 100;
            }

            // Anima a barra de progresso
            setTimeout(() => {
                globalProgressBar.style.width = `${Math.min(progress, 100)}%`;
            }, 100);

            // Atualiza o progresso específico de cada Era (se a timeline estiver visível)
            if (!state.isSearching) {
                updateEraProgress();
            }
        }

        // Atualiza o progresso visual nos cabeçalhos de Era
        function updateEraProgress() {
            for (const decade in state.groupedItems) {
                const eraItems = state.groupedItems[decade];
                const total = eraItems.length;
                const discovered = eraItems.filter(item => state.playerData.discoveredItems.has(item.id)).length;
                
                const progressElement = document.getElementById(`era-progress-${decade}`);
                if (progressElement) {
                    progressElement.textContent = `${discovered} / ${total}`;
                }
            }
        }

        // Lida com o clique no item (Marca como descoberto antes de navegar)
        function handleItemClick(itemId, event) {
            // Previne a ação se o utilizador estiver a tentar abrir num novo separador
             if (event.ctrlKey || event.metaKey || event.shiftKey || event.button !== 0) {
                 return;
            }

            // Se já foi descoberto, navega imediatamente
            if (state.playerData.discoveredItems.has(itemId)) {
                return;
            }

            // 1. Impede a navegação imediata
            event.preventDefault();

            // 2. Processa a descoberta
            state.playerData.discoveredItems.add(itemId);
            savePlayerData();
            updateStatusMonitor();
            
            // 3. Atualiza visualmente o cartão clicado (Feedback Instantâneo)
            // Encontra o cartão correto usando o atributo data-item-id
            const card = document.querySelector(`.gallery-card[data-item-id="${itemId}"]`);
            if (card) {
                card.classList.remove('undiscovered');
                card.classList.add('discovered');
                const indicator = card.querySelector('.status-indicator');
                if (indicator) {
                    indicator.textContent = 'OK';
                }
            }

            // 4. Navega após um pequeno atraso para o utilizador ver o feedback visual (transição do filtro CSS)
            setTimeout(() => {
                window.location.href = `item_detalhe.html?id=${itemId}`;
            }, 350); // 350ms de atraso
        }

        // --- DATA PROCESSING FUNCTIONS (Nova Lógica de Agrupamento) ---

        // Agrupa os itens por década
        function groupItemsByDecade(items) {
            const grouped = items.reduce((acc, item) => {
                let decade = 'Indefinido';
                if (item.lancamento) {
                    const year = parseInt(item.lancamento, 10);
                    if (!isNaN(year) && year > 1900) {
                        // Calcula a década (ex: 1985 -> 1980)
                        decade = Math.floor(year / 10) * 10;
                    }
                }
                
                if (!acc[decade]) {
                    acc[decade] = [];
                }
                acc[decade].push(item);
                return acc;
            }, {});

            // Ordena os itens dentro de cada década por ano exato (Ascendente)
            for (const decade in grouped) {
                grouped[decade].sort((a, b) => {
                    const yearA = parseInt(a.lancamento, 10) || 0;
                    const yearB = parseInt(b.lancamento, 10) || 0;
                    // Se o ano for igual, ordena por nome
                    if (yearA === yearB) {
                        return (a.nome || "").localeCompare(b.nome || "");
                    }
                    return yearA - yearB;
                });
            }

            return grouped;
        }


        // --- RENDER FUNCTIONS (Reimaginadas) ---

        // Função auxiliar para criar o HTML de um cartão
        function createCardHTML(item) {
            const isDiscovered = state.playerData.discoveredItems.has(item.id);
            const statusClass = isDiscovered ? 'discovered' : 'undiscovered';
            const statusText = isDiscovered ? 'OK' : '???';

            return `
                <div class="gallery-card ${statusClass}" data-item-id="${item.id}">
                    <div class="status-indicator pixel-font">${statusText}</div>
                    <div class="card-image-container">
                        <a href="item_detalhe.html?id=${item.id}" class="block item-link">
                            <img src="${item.imagem_principal || 'https://placehold.co/400x300/333/666?text=NO+DATA'}" alt="Imagem de ${item.nome || 'Item'}" class="w-full h-40 object-contain transition duration-300 hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/400x300/333/666?text=ERROR';">
                        </a>
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-xl mb-2 text-gray-900">${item.nome || '>_Sem nome'}</h3>
                        <div class="text-lg mb-4">
                            ${item.lancamento ? `<p>[${item.lancamento}]</p>` : ''}
                        </div>
                        <a href="item_detalhe.html?id=${item.id}" class="item-link mt-auto text-center">
                            ACESSAR REGISTRO
                        </a>
                    </div>
                </div>
            `;
        }

        // Renderiza a estrutura completa da Linha do Tempo (Eras)
        function renderTimeline() {
            // Limpa o container, exceto o loader e os resultados de pesquisa
            const elementsToKeep = [galleryLoader, searchResultsContainer];
            Array.from(galleryContainer.children).forEach(child => {
                if (!elementsToKeep.includes(child)) {
                    child.remove();
                }
            });

            // Ordena as décadas (chaves)
            const sortedDecades = Object.keys(state.groupedItems).sort((a, b) => {
                if (a === 'Indefinido') return 1; // Indefinido no final
                if (b === 'Indefinido') return -1;
                return parseInt(a, 10) - parseInt(b, 10); // Ordem cronológica ascendente
            });

            sortedDecades.forEach(decade => {
                const eraSection = document.createElement('section');
                eraSection.className = 'era-section';
                // Adiciona a classe 'hidden' se estivermos em modo de pesquisa (para o caso de os dados atualizarem)
                if (state.isSearching) {
                    eraSection.classList.add('hidden');
                }
                
                const title = decade === 'Indefinido' ? 'ERA INDEFINIDA' : `ERA ${decade}s`;

                eraSection.innerHTML = `
                    <div class="era-header">
                        <h2 class="text-2xl pixel-font text-glow-magenta">${title}</h2>
                        <div id="era-progress-${decade}" class="pixel-font text-sm text-glow-magenta">0 / 0</div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                        ${state.groupedItems[decade].map(createCardHTML).join('')}
                    </div>
                `;

                galleryContainer.appendChild(eraSection);
            });

            // Adiciona os listeners de clique aos novos cartões
            addClickListeners(galleryContainer);
            updateEraProgress();
        }

        // Renderiza apenas os resultados da pesquisa
        function renderSearchResults(filteredItems) {
            searchResultsGrid.innerHTML = '';

            if (filteredItems.length === 0) {
                searchResultsGrid.innerHTML = `<div class="col-span-full text-center py-20"><i class="fas fa-exclamation-triangle text-4xl text-yellow-500"></i><p class="mt-4 text-xl">>_ Nenhum item encontrado para "${searchInput.value.trim()}".</p></div>`;
                return;
            }

            // Ordena os resultados da pesquisa por nome
            filteredItems.sort((a, b) => (a.nome || "").localeCompare(b.nome || ""));

            filteredItems.forEach(item => {
                const cardHTML = createCardHTML(item);
                searchResultsGrid.innerHTML += cardHTML;
            });

             // Adiciona os listeners de clique aos cartões de pesquisa
             addClickListeners(searchResultsGrid);
        }

        // Função auxiliar para adicionar listeners de clique
        function addClickListeners(container) {
            const links = container.querySelectorAll('.item-link');
            links.forEach(link => {
                const card = link.closest('.gallery-card');
                if (card) {
                    const itemId = card.getAttribute('data-item-id');
                    // Adiciona o listener. Como estamos a reconstruir o HTML, não precisamos de nos preocupar com listeners antigos.
                    link.addEventListener('click', (event) => handleItemClick(itemId, event));
                }
            });
        }


        // --- SEARCH FUNCTIONALITY (Adaptada para alternar visualizações) ---
        
        let searchTimeout = null;

        function handleSearchInput() {
            // Debounce: Espera 300ms após o utilizador parar de digitar para executar a pesquisa
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                handleSearch();
            }, 300);
        }

        function handleSearch() {
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm.length > 0) {
                state.isSearching = true;
                // Esconde as seções de Era
                document.querySelectorAll('.era-section').forEach(el => el.classList.add('hidden'));
                // Mostra o container de resultados de pesquisa
                searchResultsContainer.classList.remove('hidden');

                // Lógica de filtragem (pesquisa parcial e insensível a maiúsculas/minúsculas)
                const searchRegex = new RegExp(searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'i');
                const filteredItems = state.items.filter(item =>
                    item.nome && searchRegex.test(item.nome)
                );

                renderSearchResults(filteredItems);
                updateAutocomplete(searchTerm);

            } else {
                clearSearch();
            }
        }

        function clearSearch() {
            state.isSearching = false;
            searchInput.value = '';
            // Mostra as seções de Era novamente
            document.querySelectorAll('.era-section').forEach(el => el.classList.remove('hidden'));
            // Esconde o container de resultados de pesquisa
            searchResultsContainer.classList.add('hidden');
            autocompleteResults.classList.add('hidden');
            // Garante que o progresso da Era seja atualizado ao sair da pesquisa
            updateEraProgress();
        }

        // (Mantida a funcionalidade de autocomplete)
        function updateAutocomplete(query) {
             autocompleteResults.innerHTML = '';
             if (query.length < 2) { // Requer pelo menos 2 caracteres
                 autocompleteResults.classList.add('hidden');
                 return;
            }

            const searchRegex = new RegExp(query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'i');
            const matchedItems = state.items
                .filter(item => item.nome && searchRegex.test(item.nome))
                .slice(0, 5);

            if (matchedItems.length > 0) {
                matchedItems.forEach(item => {
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.className = 'autocomplete-item pixel-font text-xs py-2';
                    suggestionDiv.textContent = item.nome;
                    suggestionDiv.onclick = () => {
                        searchInput.value = item.nome;
                        autocompleteResults.classList.add('hidden');
                        handleSearch();
                    };
                    autocompleteResults.appendChild(suggestionDiv);
                });
                autocompleteResults.classList.remove('hidden');
            } else {
                autocompleteResults.classList.add('hidden');
            }
        }
        
        // --- DATA FETCHING ---
        function carregarAcervo() {
            try {
                const acervosRef = collection(db, `/artifacts/${appId}/public/data/acervos`);
                onSnapshot(query(acervosRef), (querySnapshot) => {
                    state.items = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.totalItemsCount = state.items.length;
                    
                    // Processa os dados para agrupar por década
                    state.groupedItems = groupItemsByDecade(state.items);

                    if (galleryLoader) galleryLoader.style.display = 'none';
                    
                    // Renderiza a nova estrutura da Linha do Tempo
                    renderTimeline();
                    // Atualiza o Monitor de Status com a contagem total correta
                    updateStatusMonitor(); 

                    // Se estivermos a meio de uma pesquisa quando os dados atualizam (e.g. Firestore update)
                    if (state.isSearching) {
                        handleSearch();
                    }

                }, (error) => {
                    console.error("Erro ao carregar o acervo:", error);
                    if (galleryLoader) galleryLoader.style.display = 'none';
                    galleryContainer.innerHTML = `<p class="col-span-full text-center text-red-500 text-2xl py-20">>_ ERRO CRÍTICO: Falha ao conectar ao banco de dados.</p>`;
                });
            } catch (error) {
                console.error("Erro ao configurar o listener do acervo:", error);
                if (galleryLoader) galleryLoader.style.display = 'none';
                galleryContainer.innerHTML = `<p class="col-span-full text-center text-red-500 text-2xl py-20">>_ ERRO INESPERADO NO SISTEMA.</p>`;
            }
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPlayerData(); // Carrega os dados do jogador primeiro
            carregarAcervo();
            
            // Usa a função com debounce para o input
            searchInput.addEventListener('input', () => handleSearchInput());
            clearSearchBtn.addEventListener('click', () => clearSearch());

            document.addEventListener('click', (e) => {
                if (!document.getElementById('search-container').contains(e.target)) {
                    autocompleteResults.classList.add('hidden');
                }
            });
        });

    </script>
</body>
</html>