<!-- Conteúdo da Aba Home (Gestor de Carrossel) -->
<div id="home-slider-manager" class="space-y-8">

    <!-- Seção de Configurações -->
    <div class="form-section bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6">Configurações Gerais do Carrossel</h2>
        <form id="form-home-config" class="space-y-4">
            <div class="max-w-sm">
                <label for="home-config-duracao" class="block text-sm font-medium text-gray-700">Duração Padrão do Slide (segundos)</label>
                <input type="number" id="home-config-duracao" min="1" placeholder="Ex: 7" class="mt-1">
                <p class="text-xs text-gray-500 mt-1">Define quanto tempo cada slide de IMAGEM fica visível. Vídeos tocarão até o fim automaticamente.</p>
            </div>
            <div class="flex gap-4 pt-2">
                <button type="submit">Guardar Configuração</button>
            </div>
        </form>
    </div>


    <div class="form-section bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6">Gerir Slides do Carrossel</h2>
        <form id="form-home-slider" class="space-y-6">
            <input type="hidden" id="home-slider-id">
            
            <fieldset class="border p-4 rounded-md">
                <legend class="text-lg font-semibold px-2">Mídia e Pré-visualização</legend>
                
                <div data-upload-container="home-slider-media" class="pt-2">
                    <input type="hidden" id="home-slider-media-url">
                    <input type="hidden" id="home-slider-media-tipo">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mídia de Fundo (Imagem ou Vídeo)</label>
                    
                    <div id="interactive-preview-wrapper" class="upload-preview-wrapper hidden mb-4">
                        <div id="positioning-container" class="upload-preview-container relative rounded-lg overflow-hidden bg-gray-900 group">
                            <img src="#" alt="Preview da imagem" class="upload-preview" data-media-type="imagem">
                            <video src="#" alt="Preview do vídeo" class="upload-preview" data-media-type="video" controls muted></video>
                            <div class="absolute inset-0 bg-black bg-opacity-20 group-hover:bg-opacity-10 transition-all"></div>
                            
                            <!-- ADICIONADO: Guias de centralização para o efeito de "imã" -->
                            <div id="center-guide-y" class="absolute top-0 bottom-0 left-1/2 w-px bg-red-500 opacity-75 hidden" style="transform: translateX(-50%);"></div>
                            <div id="center-guide-x" class="absolute left-0 right-0 top-1/2 h-px bg-red-500 opacity-75 hidden" style="transform: translateY(-50%);"></div>

                            <div id="draggable-title-preview" class="absolute text-white p-2 cursor-move select-none text-center" style="left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 36px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); white-space: nowrap; font-weight: 400;">
                                Título de Exemplo
                            </div>
                            <!-- BOTÃO DE PREVIEW ADICIONADO AQUI -->
                            <div id="button-preview" class="absolute bottom-10 left-1/2 -translate-x-1/2 hidden">
                                <button type="button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg text-sm" style="pointer-events: none;">Ver Mais</button>
                            </div>
                        </div>
                        <button type="button" class="remove-upload-btn mt-2 text-sm text-red-600 hover:text-red-800">Remover mídia</button>
                    </div>

                    <div class="upload-drop-zone">
                        <input type="file" class="upload-file-input hidden" accept="image/*,video/*">
                        <div class="text-gray-500">
                            <i class="fas fa-photo-video text-3xl mb-2"></i>
                            <p><strong>Arraste e solte</strong> ou <strong>clique para selecionar</strong></p>
                            <p class="text-xs mt-1">Imagens (JPG, PNG, WEBP) ou Vídeos (MP4)</p>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset class="border p-4 rounded-md">
                <legend class="text-lg font-semibold px-2">Conteúdo e Estilo do Título</legend>
                <div class="space-y-6 pt-2">
                    <div>
                        <!-- ADICIONADO: Botão para recentralizar o título -->
                        <div class="flex justify-between items-center mb-1">
                            <label for="home-slider-titulo" class="block text-sm font-medium text-gray-700">Texto do Título</label>
                            <button type="button" id="recenter-title-btn" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-md">Centralizar</button>
                        </div>
                        <textarea id="home-slider-titulo" placeholder="Ex: A Era de Ouro dos Arcades" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                         <p class="text-xs text-gray-500 mt-1">Use a tecla Enter para criar quebras de linha manuais.</p>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="titulo-font-family" class="block text-sm font-medium text-gray-700">Fonte</label>
                            <select id="titulo-font-family" class="mt-1">
                                <option value="Inter, sans-serif">Inter (Padrão)</option>
                                <option value="'Lora', serif">Lora (Serifado)</option>
                                <option value="'Press Start 2P', cursive">Press Start 2P (Pixel)</option>
                                <option value="'Bungee', cursive">Bungee (Impacto)</option>
                                <option value="'Orbitron', sans-serif">Orbitron (Futurista)</option>
                            </select>
                        </div>
                        <div>
                            <label for="titulo-font-size" class="block text-sm font-medium text-gray-700">Tamanho (px)</label>
                            <input type="number" id="titulo-font-size" value="36" class="mt-1">
                        </div>
                         <div>
                            <label for="titulo-color" class="block text-sm font-medium text-gray-700">Cor</label>
                            <input type="color" id="titulo-color" value="#FFFFFF" class="mt-1 h-10 w-full">
                        </div>
                        <div>
                            <label for="titulo-font-weight" class="block text-sm font-medium text-gray-700">Peso da Fonte</label>
                            <select id="titulo-font-weight" class="mt-1">
                                <option value="100">100 (Fina)</option>
                                <option value="200">200 (Extra Leve)</option>
                                <option value="300">300 (Leve)</option>
                                <option value="400" selected>400 (Normal)</option>
                                <option value="500">500 (Média)</option>
                                <option value="600">600 (Semi-negrito)</option>
                                <option value="700">700 (Negrito)</option>
                                <option value="800">800 (Extra Negrito)</option>
                                <option value="900">900 (Preta)</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 border-t pt-4">
                        <div>
                            <label for="titulo-line-height" class="block text-sm font-medium text-gray-700">Espaç. Linhas</label>
                            <input type="number" id="titulo-line-height" value="1.2" step="0.1" class="mt-1">
                             <p class="text-xs text-gray-500 mt-1">Ex: 1.2, 1.5</p>
                        </div>
                        <div>
                            <label for="titulo-letter-spacing" class="block text-sm font-medium text-gray-700">Espaç. Letras (px)</label>
                            <input type="number" id="titulo-letter-spacing" value="0" class="mt-1">
                            <p class="text-xs text-gray-500 mt-1">Pode ser negativo</p>
                        </div>
                        <div>
                            <label for="titulo-text-transform" class="block text-sm font-medium text-gray-700">Transformação</label>
                             <select id="titulo-text-transform" class="mt-1">
                                 <option value="none">Nenhuma</option>
                                 <option value="uppercase">MAIÚSCULAS</option>
                                 <option value="lowercase">minúsculas</option>
                                 <option value="capitalize">Capitalizado</option>
                             </select>
                        </div>
                    </div>

                    <div class="space-y-4 border-t pt-4">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="checkbox" id="titulo-text-shadow-enable" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            Ativar Sombra no Texto
                        </label>
                        <div id="text-shadow-controls" class="hidden grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2">
                             <div>
                                 <label for="titulo-text-shadow-color" class="block text-xs font-medium text-gray-500">Cor Sombra</label>
                                 <input type="color" id="titulo-text-shadow-color" value="#000000" class="mt-1 h-10 w-full">
                             </div>
                            <div>
                                <label for="titulo-text-shadow-blur" class="block text-xs font-medium text-gray-500">Borrão (px)</label>
                                <input type="range" id="titulo-text-shadow-blur" min="0" max="20" value="4" class="mt-1 w-full">
                            </div>
                            <div>
                                <label for="titulo-text-shadow-offset-x" class="block text-xs font-medium text-gray-500">Offset X (px)</label>
                                <input type="range" id="titulo-text-shadow-offset-x" min="-10" max="10" value="2" class="mt-1 w-full">
                            </div>
                            <div>
                                <label for="titulo-text-shadow-offset-y" class="block text-xs font-medium text-gray-500">Offset Y (px)</label>
                                <input type="range" id="titulo-text-shadow-offset-y" min="-10" max="10" value="2" class="mt-1 w-full">
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="titulo-pos-x" value="50">
                    <input type="hidden" id="titulo-pos-y" value="50">
                </div>
            </fieldset>

            <fieldset class="border p-4 rounded-md">
                <legend class="text-lg font-semibold px-2">Link e Ordem</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                    <div>
                        <label for="home-slider-linkTexto" class="block text-sm font-medium text-gray-700">Texto do Botão (Opcional)</label>
                        <select id="home-slider-linkTexto" class="mt-1">
                            <option value="">Sem Botão</option>
                            <option value="Ver Mais">Ver Mais</option>
                            <option value="Ler Notícia">Ler Notícia</option>
                            <option value="Explorar Acervo">Explorar Acervo</option>
                            <option value="Jogar Agora">Jogar Agora</option>
                            <option value="Saiba Mais">Saiba Mais</option>
                        </select>
                    </div>
                    <div>
                        <label for="home-slider-linkUrl" class="block text-sm font-medium text-gray-700">URL do Link</label>
                        <input type="url" id="home-slider-linkUrl" placeholder="Cole a URL completa aqui" class="mt-1" disabled>
                        <p class="text-xs text-gray-500 mt-1">Obrigatório se um texto de botão for escolhido.</p>
                    </div>
                    <div class="md:col-span-2">
                        <label for="home-slider-ordem" class="block text-sm font-medium text-gray-700">Ordem de Exibição</label>
                        <input type="number" id="home-slider-ordem" placeholder="Ex: 1, 2, 3... (menor aparece primeiro)" min="0" class="mt-1">
                    </div>
                </div>
            </fieldset>
            
            <div id="home-slider-upload-progress-container" class="hidden mt-4 w-full bg-gray-200 rounded-full h-4">
                <div id="home-slider-upload-progress-bar" class="bg-blue-600 h-4 rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none" style="width: 0%">0%</div>
            </div>

            <div class="flex gap-4 pt-4">
                <button type="submit">Guardar Slide</button>
                <button type="button" id="cancel-home-slider-edit" class="w-auto">Cancelar</button>
            </div>
        </form>
    </div>

    <div class="bg-white p-8 rounded-lg shadow-md">
        <h3 class="text-xl font-bold mb-4">Slides do Carrossel</h3>
        <div id="home-slider-lista" class="space-y-4">
             <p class="text-sm text-gray-500">A carregar slides...</p>
        </div>
    </div>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Inter:wght@100..900&family=Lora:wght@400..700&family=Orbitron:wght@400..900&family=Press+Start+2P&display=swap" rel="stylesheet">
</div>

<script data-tab-script="home-slider">
{
    const { db, storage, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, getDoc, query, orderBy, ref, deleteObject } = window.firebaseServices;
    const { appId } = window.appConfig;

    const entity = 'home-slider';
    const form = document.getElementById(`form-${entity}`);
    const listContainer = document.getElementById(`${entity}-lista`);
    
    const configForm = document.getElementById('form-home-config');
    const duracaoInput = document.getElementById('home-config-duracao');
    const configDocRef = doc(db, `/artifacts/${appId}/public/data/configuracoes/carrossel`);
    
    // --- Elementos do Título ---
    const tituloInput = document.getElementById('home-slider-titulo');
    const fontFamilySelect = document.getElementById('titulo-font-family');
    const fontSizeInput = document.getElementById('titulo-font-size');
    const colorInput = document.getElementById('titulo-color');
    const fontWeightSelect = document.getElementById('titulo-font-weight');
    const lineHeightInput = document.getElementById('titulo-line-height');
    const letterSpacingInput = document.getElementById('titulo-letter-spacing');
    const textTransformSelect = document.getElementById('titulo-text-transform');
    const recenterBtn = document.getElementById('recenter-title-btn'); // Botão de centralizar
    
    // --- Elementos da Sombra ---
    const shadowEnableCheckbox = document.getElementById('titulo-text-shadow-enable');
    const shadowControlsContainer = document.getElementById('text-shadow-controls');
    const shadowColorInput = document.getElementById('titulo-text-shadow-color');
    const shadowBlurInput = document.getElementById('titulo-text-shadow-blur');
    const shadowOffsetXInput = document.getElementById('titulo-text-shadow-offset-x');
    const shadowOffsetYInput = document.getElementById('titulo-text-shadow-offset-y');

    // --- Elementos da Pré-visualização ---
    const posXInput = document.getElementById('titulo-pos-x');
    const posYInput = document.getElementById('titulo-pos-y');
    const draggableTitle = document.getElementById('draggable-title-preview');
    const positioningContainer = document.getElementById('positioning-container');
    const buttonPreview = document.getElementById('button-preview');
    const centerGuideX = document.getElementById('center-guide-x'); // Guia horizontal
    const centerGuideY = document.getElementById('center-guide-y'); // Guia vertical
    
    // --- Elementos do Link ---
    const linkTextoSelect = document.getElementById('home-slider-linkTexto');
    const linkUrlInput = document.getElementById('home-slider-linkUrl');

    const updateButtonPreview = () => {
        const selectedText = linkTextoSelect.value;
        if (selectedText) {
            buttonPreview.querySelector('button').textContent = selectedText;
            buttonPreview.classList.remove('hidden');
        } else {
            buttonPreview.classList.add('hidden');
        }
    };

    const updateTitlePreview = () => {
        const titleText = tituloInput.value || "Título de Exemplo";
        draggableTitle.innerHTML = titleText.replace(/\n/g, '<br>');
        
        draggableTitle.style.fontFamily = fontFamilySelect.value;
        draggableTitle.style.fontSize = `${fontSizeInput.value || 36}px`;
        draggableTitle.style.color = colorInput.value;
        draggableTitle.style.fontWeight = fontWeightSelect.value || '400';
        draggableTitle.style.lineHeight = lineHeightInput.value || '1.2';
        draggableTitle.style.letterSpacing = `${letterSpacingInput.value || 0}px`;
        draggableTitle.style.textTransform = textTransformSelect.value || 'none';

        if (shadowEnableCheckbox.checked) {
            const x = shadowOffsetXInput.value;
            const y = shadowOffsetYInput.value;
            const blur = shadowBlurInput.value;
            const color = shadowColorInput.value;
            draggableTitle.style.textShadow = `${x}px ${y}px ${blur}px ${color}`;
        } else {
            draggableTitle.style.textShadow = 'none';
        }
    };
    
    const allControls = [
        tituloInput, fontFamilySelect, fontSizeInput, colorInput, fontWeightSelect,
        lineHeightInput, letterSpacingInput, textTransformSelect, shadowEnableCheckbox,
        shadowColorInput, shadowBlurInput, shadowOffsetXInput, shadowOffsetYInput
    ];
    allControls.forEach(control => {
        control.addEventListener('input', updateTitlePreview);
        control.addEventListener('change', updateTitlePreview);
    });

    shadowEnableCheckbox.addEventListener('change', () => {
        shadowControlsContainer.classList.toggle('hidden', !shadowEnableCheckbox.checked);
    });

    let isDragging = false;
    let offsetX, offsetY;

    const onDragStart = (e) => {
        isDragging = true;
        draggableTitle.style.transition = 'none';
        const rect = draggableTitle.getBoundingClientRect();
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        offsetX = clientX - rect.left;
        offsetY = clientY - rect.top;
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('touchend', onDragEnd);
        e.preventDefault();
    };

    // MODIFICADO: Lógica de arrastar com "imã" de centralização
    const onDragMove = (e) => {
        if (!isDragging) return;
        
        centerGuideX.classList.add('hidden');
        centerGuideY.classList.add('hidden');

        const containerRect = positioningContainer.getBoundingClientRect();
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        
        let newX = clientX - containerRect.left - offsetX;
        let newY = clientY - containerRect.top - offsetY;

        let xPercent = (newX + draggableTitle.offsetWidth / 2) / containerRect.width * 100;
        let yPercent = (newY + draggableTitle.offsetHeight / 2) / containerRect.height * 100;

        const snapThreshold = 5; // Tolerância de 5% para o "imã"

        // Snap para o centro horizontal (eixo Y)
        if (Math.abs(xPercent - 50) < snapThreshold) {
            xPercent = 50;
            centerGuideY.classList.remove('hidden'); // Mostra guia vertical
        }

        // Snap para o centro vertical (eixo X)
        if (Math.abs(yPercent - 50) < snapThreshold) {
            yPercent = 50;
            centerGuideX.classList.remove('hidden'); // Mostra guia horizontal
        }

        draggableTitle.style.left = `${xPercent}%`;
        draggableTitle.style.top = `${yPercent}%`;
        
        posXInput.value = xPercent.toFixed(2);
        posYInput.value = yPercent.toFixed(2);
        
        e.preventDefault();
    };

    const onDragEnd = () => {
        isDragging = false;
        draggableTitle.style.transition = '';
        
        // Esconde as guias ao soltar o mouse
        centerGuideX.classList.add('hidden');
        centerGuideY.classList.add('hidden');

        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('touchend', onDragEnd);
    };

    draggableTitle.addEventListener('mousedown', onDragStart);
    draggableTitle.addEventListener('touchstart', onDragStart, { passive: false });

    // ADICIONADO: Evento do botão para centralizar
    recenterBtn.addEventListener('click', () => {
        posXInput.value = "50";
        posYInput.value = "50";
        draggableTitle.style.left = '50%';
        draggableTitle.style.top = '50%';
        draggableTitle.style.transition = 'top 0.3s ease, left 0.3s ease';
        setTimeout(() => {
            draggableTitle.style.transition = '';
        }, 300);
    });

    const clearForm = () => {
        form.reset();
        document.getElementById(`${entity}-id`).value = '';
        linkTextoSelect.value = '';
        linkUrlInput.value = '';
        linkUrlInput.disabled = true;
        if (window.resetUploadUI) window.resetUploadUI(`${entity}-media`);
        
        posXInput.value = "50";
        posYInput.value = "50";
        fontSizeInput.value = "36";
        fontFamilySelect.value = "Inter, sans-serif";
        colorInput.value = "#FFFFFF";
        fontWeightSelect.value = "400";
        lineHeightInput.value = "1.2";
        letterSpacingInput.value = "0";
        textTransformSelect.value = "none";
        
        shadowEnableCheckbox.checked = false;
        shadowControlsContainer.classList.add('hidden');
        shadowColorInput.value = "#000000";
        shadowBlurInput.value = "4";
        shadowOffsetXInput.value = "2";
        shadowOffsetYInput.value = "2";

        draggableTitle.style.left = '50%';
        draggableTitle.style.top = '50%';
        updateTitlePreview();
        updateButtonPreview();
    };

    const editDoc = async (id) => {
        clearForm();
        try {
            const docRef = doc(db, `/artifacts/${appId}/public/data/${entity}`, id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById(`${entity}-id`).value = docSnap.id;
                tituloInput.value = data.titulo || '';
                document.getElementById(`${entity}-ordem`).value = data.ordem || 0;
                
                linkTextoSelect.value = data.linkTexto || '';
                linkUrlInput.value = data.linkUrl || '';
                linkUrlInput.disabled = !data.linkTexto;
                
                if (data.tituloEstilo) {
                    const estilo = data.tituloEstilo;
                    fontFamilySelect.value = estilo.fontFamily || "Inter, sans-serif";
                    fontSizeInput.value = estilo.fontSize || 36;
                    colorInput.value = estilo.color || "#FFFFFF";
                    fontWeightSelect.value = estilo.fontWeight || '400';
                    lineHeightInput.value = estilo.lineHeight || 1.2;
                    letterSpacingInput.value = estilo.letterSpacing || 0;
                    textTransformSelect.value = estilo.textTransform || 'none';
                    
                    if (estilo.textShadow && estilo.textShadow !== 'none') {
                        shadowEnableCheckbox.checked = true;
                        shadowControlsContainer.classList.remove('hidden');
                        const shadowParts = estilo.textShadow.match(/-?\d+(\.\d+)?px|#\w{3,6}|\w+/g) || [];
                        if (shadowParts.length >= 4) {
                            shadowOffsetXInput.value = parseFloat(shadowParts[0]);
                            shadowOffsetYInput.value = parseFloat(shadowParts[1]);
                            shadowBlurInput.value = parseFloat(shadowParts[2]);
                            shadowColorInput.value = shadowParts[3];
                        }
                    } else {
                         shadowEnableCheckbox.checked = false;
                         shadowControlsContainer.classList.add('hidden');
                    }
                }
                
                if (data.tituloPosicao) {
                    posXInput.value = data.tituloPosicao.x || 50;
                    posYInput.value = data.tituloPosicao.y || 50;
                    draggableTitle.style.left = `${data.tituloPosicao.x || 50}%`;
                    draggableTitle.style.top = `${data.tituloPosicao.y || 50}%`;
                }
                updateTitlePreview();
                updateButtonPreview();

                if (data.mediaUrl) {
                    const container = document.querySelector(`[data-upload-container="${entity}-media"]`);
                    const previewImg = container.querySelector('img.upload-preview');
                    const previewVideo = container.querySelector('video.upload-preview');
                    
                    previewImg.style.display = 'none';
                    previewVideo.style.display = 'none';

                    if (data.mediaTipo === 'video') {
                        previewVideo.src = data.mediaUrl;
                        previewVideo.style.display = 'block';
                    } else {
                        previewImg.src = data.mediaUrl;
                        previewImg.style.display = 'block';
                    }

                    document.getElementById('interactive-preview-wrapper').classList.remove('hidden');
                    container.querySelector('.upload-drop-zone').classList.add('hidden');
                    document.getElementById(`${entity}-media-url`).value = data.mediaUrl;
                    document.getElementById(`${entity}-media-tipo`).value = data.mediaTipo;
                }
                window.scrollTo(0, 0);
            }
        } catch (error) {
            console.error(`Erro ao carregar ${entity}:`, error);
            if (window.showNotification) window.showNotification('Erro ao carregar dados.', true);
        }
    };
    
    const performDeleteDoc = async (id) => {
        if (!await window.showConfirmModal()) return;
        try {
            const docRef = doc(db, `/artifacts/${appId}/public/data/${entity}`, id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.mediaUrl && typeof data.mediaUrl === 'string') {
                    const fileRef = ref(storage, data.mediaUrl);
                    await deleteObject(fileRef).catch(err => console.warn("Não foi possível apagar o ficheiro do Storage:", err));
                }
            }
            await deleteDoc(docRef);
            if (window.showNotification) window.showNotification("Slide eliminado com sucesso!");
            clearForm();
        } catch (error) {
            console.error(`Erro ao eliminar ${entity}:`, error);
            if (window.showNotification) window.showNotification("Erro ao eliminar o slide.", true);
        }
    };

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        const progressContainer = document.getElementById(`${entity}-upload-progress-container`);
        const progressBar = document.getElementById(`${entity}-upload-progress-bar`);
        submitButton.disabled = true;

        const textShadowValue = shadowEnableCheckbox.checked
            ? `${shadowOffsetXInput.value}px ${shadowOffsetYInput.value}px ${shadowBlurInput.value}px ${shadowColorInput.value}`
            : 'none';

        const data = {
            titulo: tituloInput.value,
            linkTexto: linkTextoSelect.value,
            linkUrl: linkUrlInput.value,
            ordem: Number(document.getElementById(`${entity}-ordem`).value) || 0,
            mediaUrl: document.getElementById(`${entity}-media-url`).value,
            mediaTipo: document.getElementById(`${entity}-media-tipo`).value,
            tituloEstilo: {
                fontFamily: fontFamilySelect.value,
                fontSize: fontSizeInput.value,
                color: colorInput.value,
                fontWeight: fontWeightSelect.value,
                lineHeight: lineHeightInput.value,
                letterSpacing: letterSpacingInput.value,
                textTransform: textTransformSelect.value,
                textShadow: textShadowValue
            },
            tituloPosicao: {
                x: posXInput.value,
                y: posYInput.value
            }
        };

        try {
            if (data.linkTexto && !data.linkUrl) {
                throw new Error("Se um texto de botão for escolhido, a URL do link é obrigatória.");
            }
            
            const file = window.pendingFiles.get(`${entity}-media`);
            if (file) {
                progressContainer.classList.remove('hidden');
                // CORREÇÃO APLICADA AQUI
                const uploadResult = await window.uploadFile(file, 'home_slider/', (progress) => {
                    const percent = Math.round(progress * 100);
                    progressBar.style.width = `${percent}%`;
                    progressBar.textContent = `${percent}%`;
                });
                data.mediaUrl = uploadResult.url; // Extrai a URL do objeto retornado
                data.mediaTipo = uploadResult.type.startsWith('video/') ? 'video' : 'imagem';
                window.pendingFiles.delete(`${entity}-media`);
            }

            if (!data.mediaUrl) {
                throw new Error("É necessário selecionar uma imagem ou vídeo para o slide.");
            }

            const id = document.getElementById(`${entity}-id`).value;
            const path = `/artifacts/${appId}/public/data/${entity}`;
            await (id ? updateDoc(doc(db, path, id), data) : addDoc(collection(db, path), data));

            if (window.showNotification) window.showNotification('Slide guardado com sucesso!');
            clearForm();
        } catch (error) {
            console.error("Erro ao guardar slide:", error);
            if (window.showNotification) window.showNotification(error.message || 'Erro ao guardar os dados.', true);
        } finally {
            submitButton.disabled = false;
            progressContainer.classList.add('hidden');
        }
    });

    const q = query(collection(db, `/artifacts/${appId}/public/data/${entity}`), orderBy("ordem"));
    onSnapshot(q, (snapshot) => {
        listContainer.innerHTML = snapshot.empty ? '<p class="text-sm text-gray-500">Nenhum slide registado.</p>' : '';
        
        snapshot.docs.forEach(docSnap => {
            const data = docSnap.data();
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-md border';
            itemDiv.innerHTML = `
                <div class="flex-grow flex items-center gap-4">
                    <img src="${data.mediaTipo !== 'video' ? data.mediaUrl : 'https://placehold.co/100x60/e9ecef/6c757d?text=Video'}" alt="Preview" class="w-20 h-12 object-cover rounded-md bg-gray-200" onerror="this.onerror=null;this.src='https://placehold.co/100x60/e9ecef/6c757d?text=Media';">
                    <p class="font-semibold text-gray-800 truncate pr-4">${data.titulo || 'Slide sem título'}</p>
                </div>
                <div class="flex-shrink-0 flex gap-2">
                    <button class="edit-btn px-3 py-1 bg-yellow-500 text-white rounded text-xs hover:bg-yellow-600" data-id="${docSnap.id}">Editar</button>
                    <button class="delete-btn px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700" data-id="${docSnap.id}">Eliminar</button>
                </div>
            `;
            listContainer.appendChild(itemDiv);
        });
    });

    listContainer.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('edit-btn')) editDoc(target.dataset.id);
        if (target.classList.contains('delete-btn')) performDeleteDoc(target.dataset.id);
    });
    
    document.getElementById(`cancel-${entity}-edit`).addEventListener('click', clearForm);
    
    linkTextoSelect.addEventListener('change', (e) => {
        linkUrlInput.disabled = !e.target.value;
        if (!e.target.value) {
            linkUrlInput.value = '';
        }
        updateButtonPreview();
    });
    
    if (window.setupUploadComponent) {
        window.setupUploadComponent(document.querySelector(`[data-upload-container="${entity}-media"]`));
    }
    
    const uploadContainer = document.querySelector(`[data-upload-container="${entity}-media"]`);
    if (uploadContainer) {
        const fileInput = uploadContainer.querySelector('.upload-file-input');
        if (fileInput) {
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    window.pendingFiles.set(`${entity}-media`, file);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewImg = uploadContainer.querySelector('img.upload-preview');
                        const previewVideo = uploadContainer.querySelector('video.upload-preview');
                        previewImg.style.display = 'none';
                        previewVideo.style.display = 'none';
                        if (file.type.startsWith('video/')) {
                            previewVideo.src = e.target.result;
                            previewVideo.style.display = 'block';
                        } else {
                            previewImg.src = e.target.result;
                            previewImg.style.display = 'block';
                        }
                    };
                    reader.readAsDataURL(file);
                    document.getElementById('interactive-preview-wrapper').classList.remove('hidden');
                    uploadContainer.querySelector('.upload-drop-zone').classList.add('hidden');
                }
            });
        }
    }
    
    const loadConfig = async () => {
        try {
            const docSnap = await getDoc(configDocRef);
            if (docSnap.exists()) {
                duracaoInput.value = docSnap.data().duracaoSegundos || 7;
            } else {
                duracaoInput.value = 7;
            }
        } catch (error) {
            console.error("Erro ao carregar configuração:", error);
            if(window.showNotification) window.showNotification('Erro ao carregar configurações.', true);
        }
    };

    configForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const duracao = Number(duracaoInput.value);
        if (duracao > 0) {
            try {
                await setDoc(configDocRef, { duracaoSegundos: duracao }, { merge: true });
                if(window.showNotification) window.showNotification('Configuração guardada com sucesso!');
            } catch (error) {
                console.error("Erro ao guardar configuração:", error);
                if(window.showNotification) window.showNotification('Erro ao guardar a configuração.', true);
            }
        } else {
            if(window.showNotification) window.showNotification('Por favor, insira um número válido maior que zero.', true);
        }
    });

    loadConfig();
    updateTitlePreview();
    updateButtonPreview();
}
</script>
