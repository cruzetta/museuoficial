<!-- Conteúdo da Aba Home (Gestor de Carrossel) -->
<div id="home-slider-manager" class="space-y-8">

    <!-- NOVO: Seção de Configurações -->
    <div class="form-section bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6">Configurações Gerais do Carrossel</h2>
        <form id="form-home-config" class="space-y-4">
            <div class="max-w-sm">
                <label for="home-config-duracao" class="block text-sm font-medium text-gray-700">Duração Padrão do Slide (segundos)</label>
                <input type="number" id="home-config-duracao" min="1" placeholder="Ex: 7" class="mt-1">
                <p class="text-xs text-gray-500 mt-1">Define quanto tempo cada slide de IMAGEM fica visível. Vídeos tocarão até o fim automaticamente.</p>
            </div>
            <div class="flex gap-4 pt-2">
                <button type="submit">Guardar Configuração</button>
            </div>
        </form>
    </div>


    <div class="form-section bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6">Gerir Slides do Carrossel</h2>
        <form id="form-home-slider" class="space-y-6">
            <input type="hidden" id="home-slider-id">
            
            <fieldset class="border p-4 rounded-md">
                <legend class="text-lg font-semibold px-2">Conteúdo do Slide</legend>
                <div class="space-y-4 pt-2">
                    <div>
                        <label for="home-slider-titulo" class="block text-sm font-medium text-gray-700">Título (Opcional)</label>
                        <input type="text" id="home-slider-titulo" placeholder="Ex: A Era de Ouro dos Arcades">
                    </div>
                    
                    <div data-upload-container="home-slider-media">
                        <input type="hidden" id="home-slider-media-url">
                        <input type="hidden" id="home-slider-media-tipo">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mídia de Fundo (Imagem ou Vídeo)</label>
                        <div class="upload-preview-wrapper hidden mb-4">
                            <div class="upload-preview-container rounded-lg overflow-hidden bg-gray-900">
                                <img src="#" alt="Preview da imagem" class="upload-preview rounded-lg" data-media-type="imagem">
                                <video src="#" alt="Preview do vídeo" class="upload-preview rounded-lg" data-media-type="video" controls muted></video>
                            </div>
                            <button type="button" class="remove-upload-btn mt-2 text-sm text-red-600 hover:text-red-800">Remover mídia</button>
                        </div>
                        <div class="upload-drop-zone">
                            <input type="file" class="upload-file-input hidden" accept="image/*,video/*">
                            <div class="text-gray-500">
                                <i class="fas fa-photo-video text-3xl mb-2"></i>
                                <p><strong>Arraste e solte</strong> ou <strong>clique para selecionar</strong></p>
                                <p class="text-xs mt-1">Imagens (JPG, PNG, WEBP) ou Vídeos (MP4)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset class="border p-4 rounded-md">
                <legend class="text-lg font-semibold px-2">Link e Ordem</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                    <div>
                        <label for="home-slider-linkTipo" class="block text-sm font-medium text-gray-700">Link para (Opcional)</label>
                        <select id="home-slider-linkTipo">
                            <option value="nenhum">Nenhum Link</option>
                            <option value="noticia">Notícia</option>
                            <option value="acervo">Acervo</option>
                        </select>
                    </div>
                     <div>
                        <label for="home-slider-linkId" class="block text-sm font-medium text-gray-700">Item Específico</label>
                        <select id="home-slider-linkId" disabled>
                            <option value="">Primeiro selecione o tipo de link</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="home-slider-ordem" class="block text-sm font-medium text-gray-700">Ordem de Exibição</label>
                        <input type="number" id="home-slider-ordem" placeholder="Ex: 1, 2, 3... (menor aparece primeiro)" min="0">
                    </div>
                </div>
            </fieldset>
            
            <div id="home-slider-upload-progress-container" class="hidden mt-4 w-full bg-gray-200 rounded-full h-4">
                <div id="home-slider-upload-progress-bar" class="bg-blue-600 h-4 rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none" style="width: 0%">0%</div>
            </div>

            <div class="flex gap-4 pt-4">
                <button type="submit">Guardar Slide</button>
                <button type="button" id="cancel-home-slider-edit" class="w-auto">Cancelar</button>
            </div>
        </form>
    </div>

    <div class="bg-white p-8 rounded-lg shadow-md">
        <h3 class="text-xl font-bold mb-4">Slides do Carrossel</h3>
        <div id="home-slider-lista" class="space-y-4">
             <p class="text-sm text-gray-500">A carregar slides...</p>
        </div>
    </div>
</div>

<!-- Script Específico da Aba Home Slider -->
<script data-tab-script="home-slider">
{
    const { db, storage, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, getDoc, getDocs, query, orderBy, ref, deleteObject } = window.firebaseServices;
    const { appId } = window.appConfig;

    const entity = 'home-slider';
    const form = document.getElementById(`form-${entity}`);
    const listContainer = document.getElementById(`${entity}-lista`);
    
    // NOVO: Elementos do formulário de configuração
    const configForm = document.getElementById('form-home-config');
    const duracaoInput = document.getElementById('home-config-duracao');
    const configDocRef = doc(db, `/artifacts/${appId}/public/data/configuracoes/carrossel`);

    // --- State para Links ---
    const linkableData = { noticia: [], acervo: [] };

    // --- Funções do Formulário (CRUD) ---
    const clearForm = () => {
        form.reset();
        document.getElementById(`${entity}-id`).value = '';
        const linkIdSelect = document.getElementById(`${entity}-linkId`);
        linkIdSelect.innerHTML = '<option value="">Primeiro selecione o tipo de link</option>';
        linkIdSelect.disabled = true;
        if (window.resetUploadUI) window.resetUploadUI(`${entity}-media`);
    };

    const editDoc = async (id) => {
        clearForm();
        try {
            const docRef = doc(db, `/artifacts/${appId}/public/data/${entity}`, id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById(`${entity}-id`).value = docSnap.id;
                document.getElementById(`${entity}-titulo`).value = data.titulo || '';
                document.getElementById(`${entity}-ordem`).value = data.ordem || 0;
                
                const linkTipoSelect = document.getElementById(`${entity}-linkTipo`);
                linkTipoSelect.value = data.linkTipo || 'nenhum';
                linkTipoSelect.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    document.getElementById(`${entity}-linkId`).value = data.linkId || '';
                }, 100);

                if (data.mediaUrl) {
                    const container = document.querySelector(`[data-upload-container="${entity}-media"]`);
                    const previewImg = container.querySelector('img.upload-preview');
                    const previewVideo = container.querySelector('video.upload-preview');
                    
                    previewImg.style.display = 'none';
                    previewVideo.style.display = 'none';

                    if (data.mediaTipo === 'video') {
                        previewVideo.src = data.mediaUrl;
                        previewVideo.style.display = 'block';
                    } else {
                        previewImg.src = data.mediaUrl;
                        previewImg.style.display = 'block';
                    }

                    container.querySelector('.upload-preview-wrapper').classList.remove('hidden');
                    container.querySelector('.upload-drop-zone').classList.add('hidden');
                    document.getElementById(`${entity}-media-url`).value = data.mediaUrl;
                    document.getElementById(`${entity}-media-tipo`).value = data.mediaTipo;
                }
                window.scrollTo(0, 0);
            }
        } catch (error) {
            console.error(`Erro ao carregar ${entity}:`, error);
            if (window.showNotification) window.showNotification('Erro ao carregar dados.', true);
        }
    };
    
    const performDeleteDoc = async (id) => {
        if (!await window.showConfirmModal()) return;

        try {
            const docRef = doc(db, `/artifacts/${appId}/public/data/${entity}`, id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.mediaUrl) {
                    const fileRef = ref(storage, data.mediaUrl);
                    await deleteObject(fileRef).catch(err => console.warn("Não foi possível apagar o ficheiro do Storage:", err));
                }
            }

            await deleteDoc(docRef);

            if (window.showNotification) window.showNotification("Slide eliminado com sucesso!");
            clearForm();

        } catch (error) {
            console.error(`Erro ao eliminar ${entity}:`, error);
            if (window.showNotification) window.showNotification("Erro ao eliminar o slide.", true);
        }
    };

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        const progressContainer = document.getElementById(`${entity}-upload-progress-container`);
        const progressBar = document.getElementById(`${entity}-upload-progress-bar`);
        submitButton.disabled = true;

        const data = {
            titulo: document.getElementById(`${entity}-titulo`).value.trim(),
            linkTipo: document.getElementById(`${entity}-linkTipo`).value,
            linkId: document.getElementById(`${entity}-linkId`).value,
            ordem: Number(document.getElementById(`${entity}-ordem`).value) || 0,
            mediaUrl: document.getElementById(`${entity}-media-url`).value,
            mediaTipo: document.getElementById(`${entity}-media-tipo`).value,
        };

        try {
            const file = window.pendingFiles.get(`${entity}-media`);
            if (file) {
                progressContainer.classList.remove('hidden');
                data.mediaUrl = await window.uploadFile(file, 'home_slider/', (progress) => {
                    const percent = Math.round(progress * 100);
                    progressBar.style.width = `${percent}%`;
                    progressBar.textContent = `${percent}%`;
                });
                data.mediaTipo = file.type.startsWith('video/') ? 'video' : 'imagem';
                window.pendingFiles.delete(`${entity}-media`);
            }

            if (!data.mediaUrl) {
                throw new Error("É necessário selecionar uma imagem ou vídeo para o slide.");
            }

            const id = document.getElementById(`${entity}-id`).value;
            const path = `/artifacts/${appId}/public/data/${entity}`;
            await (id ? updateDoc(doc(db, path, id), data) : addDoc(collection(db, path), data));

            if (window.showNotification) window.showNotification('Slide guardado com sucesso!');
            clearForm();
        } catch (error) {
            console.error("Erro ao guardar slide:", error);
            if (window.showNotification) window.showNotification(error.message || 'Erro ao guardar os dados.', true);
        } finally {
            submitButton.disabled = false;
            progressContainer.classList.add('hidden');
        }
    });

    // --- LISTENERS E INICIALIZAÇÃO ---
    const q = query(collection(db, `/artifacts/${appId}/public/data/${entity}`), orderBy("ordem", "asc"));
    onSnapshot(q, (snapshot) => {
        listContainer.innerHTML = snapshot.empty ? '<p class="text-sm text-gray-500">Nenhum slide registado.</p>' : '';
        snapshot.docs.forEach(docSnap => {
            const data = docSnap.data();
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-md border';
            itemDiv.innerHTML = `
                <div class="flex-grow flex items-center gap-4">
                    <img src="${data.mediaTipo !== 'video' ? data.mediaUrl : 'https://placehold.co/100x60/e9ecef/6c757d?text=Video'}" alt="Preview" class="w-20 h-12 object-cover rounded-md bg-gray-200">
                    <p class="font-semibold text-gray-800 truncate pr-4">${data.titulo || 'Slide sem título'}</p>
                </div>
                <div class="flex-shrink-0 flex gap-2">
                    <button class="edit-btn px-3 py-1 bg-yellow-500 text-white rounded text-xs hover:bg-yellow-600" data-id="${docSnap.id}">Editar</button>
                    <button class="delete-btn px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700" data-id="${docSnap.id}">Eliminar</button>
                </div>
            `;
            listContainer.appendChild(itemDiv);
        });
    });

    listContainer.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('edit-btn')) {
            editDoc(target.dataset.id);
        }
        if (target.classList.contains('delete-btn')) {
            performDeleteDoc(target.dataset.id);
        }
    });
    
    document.getElementById(`cancel-${entity}-edit`).addEventListener('click', clearForm);
    
    const fetchLinkableData = async () => {
        try {
            const noticiasSnap = await getDocs(query(collection(db, `/artifacts/${appId}/public/data/noticias`), orderBy("titulo")));
            linkableData.noticia = noticiasSnap.docs.map(d => ({ id: d.id, nome: d.data().titulo }));

            const acervosSnap = await getDocs(query(collection(db, `/artifacts/${appId}/public/data/acervos`), orderBy("nome")));
            linkableData.acervo = acervosSnap.docs.map(d => ({ id: d.id, nome: d.data().nome }));
        } catch (error) {
            console.error("Erro ao carregar dados para os links:", error);
        }
    };

    document.getElementById(`${entity}-linkTipo`).addEventListener('change', (e) => {
        const linkIdSelect = document.getElementById(`${entity}-linkId`);
        const tipo = e.target.value;
        linkIdSelect.innerHTML = '';
        linkIdSelect.disabled = true;

        if (tipo === 'nenhum') {
            linkIdSelect.innerHTML = '<option value="">Primeiro selecione o tipo de link</option>';
            return;
        }

        const options = linkableData[tipo];
        if (options && options.length > 0) {
            linkIdSelect.innerHTML = '<option value="">Selecione um item...</option>';
            options.forEach(item => {
                linkIdSelect.innerHTML += `<option value="${item.id}">${item.nome}</option>`;
            });
            linkIdSelect.disabled = false;
        } else {
            linkIdSelect.innerHTML = `<option value="">Nenhum item de '${tipo}' encontrado</option>`;
        }
    });
    
    if (window.setupUploadComponent) {
        window.setupUploadComponent(document.querySelector(`[data-upload-container="${entity}-media"]`));
    }
    
    const uploadContainer = document.querySelector(`[data-upload-container="${entity}-media"]`);
    if (uploadContainer) {
        const fileInput = uploadContainer.querySelector('.upload-file-input');
        if (fileInput) {
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    window.pendingFiles.set(`${entity}-media`, file);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewImg = uploadContainer.querySelector('img.upload-preview');
                        const previewVideo = uploadContainer.querySelector('video.upload-preview');
                        previewImg.style.display = 'none';
                        previewVideo.style.display = 'none';

                        if (file.type.startsWith('video/')) {
                            previewVideo.src = e.target.result;
                            previewVideo.style.display = 'block';
                        } else {
                            previewImg.src = e.target.result;
                            previewImg.style.display = 'block';
                        }
                    };
                    reader.readAsDataURL(file);
                    uploadContainer.querySelector('.upload-preview-wrapper').classList.remove('hidden');
                    uploadContainer.querySelector('.upload-drop-zone').classList.add('hidden');
                }
            });
        }
    }
    
    // --- LÓGICA DE CONFIGURAÇÃO ---
    const loadConfig = async () => {
        try {
            const docSnap = await getDoc(configDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                duracaoInput.value = data.duracaoSegundos || 7;
            } else {
                duracaoInput.value = 7; // Valor padrão
            }
        } catch (error) {
            console.error("Erro ao carregar configuração:", error);
            if(window.showNotification) window.showNotification('Erro ao carregar configurações.', true);
        }
    };

    configForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const duracao = Number(duracaoInput.value);
        if (duracao > 0) {
            try {
                // Usamos setDoc com merge: true para criar o documento se não existir, ou atualizar se existir.
                await setDoc(configDocRef, { duracaoSegundos: duracao }, { merge: true });
                if(window.showNotification) window.showNotification('Configuração guardada com sucesso!');
            } catch (error) {
                console.error("Erro ao guardar configuração:", error);
                if(window.showNotification) window.showNotification('Erro ao guardar a configuração.', true);
            }
        } else {
            if(window.showNotification) window.showNotification('Por favor, insira um número válido maior que zero.', true);
        }
    });


    // --- INICIALIZAÇÃO GERAL ---
    fetchLinkableData();
    loadConfig();
}
</script>
