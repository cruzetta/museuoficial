<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - Museu do Videojogo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;500;700&family=Bungee&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #f59e0b;
            --primary-hover: #d97706;
            --dark-header: #111827;
            --text-dark: #212529;
            --bg-light: #f8f9fa;
            --border-color: #dee2e6;
            --correct-color: #10b981; /* Esmeralda 500 */
            --wrong-color: #ef4444; /* Vermelho 500 */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-dark); }
        h1, h2, h3 { font-family: 'Inter', sans-serif; font-weight: 600; color: var(--text-dark); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 500; text-align: center; transition: all 0.2s ease-in-out; cursor: pointer; border: 1px solid transparent; }
        .btn-primary { background-color: var(--primary-color); color: #ffffff; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-primary:disabled { background-color: #fcd34d; cursor: not-allowed; }
        .btn-secondary { background-color: #e9ecef; color: var(--text-dark); border-color: #ced4da; }
        .btn-secondary:hover { background-color: #dee2e6; border-color: #adb5bd; }
        #header-logo { height: 120px; width: auto; }
        .option-btn { width: 100%; text-align: left; background-color: #ffffff; border: 2px solid var(--border-color); padding: 1rem; font-weight: 500; border-radius: 0.5rem; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between; }
        .option-btn:hover { background-color: #f1f5f9; }
        .option-btn.selected { border-color: var(--primary-color); background-color: #fef3c7; }
        .option-btn.correct { border-color: var(--correct-color); background-color: #d1fae5; color: #065f46; font-weight: 700; }
        .option-btn.wrong { border-color: var(--wrong-color); background-color: #fee2e2; color: #991b1b; }
        .option-btn:disabled { cursor: not-allowed; }
        .option-btn .feedback-icon { display: none; }
        .option-btn.correct .feedback-icon.fa-check, .option-btn.wrong .feedback-icon.fa-times { display: inline-block; }
        #progress-bar-inner { transition: width 0.3s ease-in-out; }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <header class="sticky top-0 z-50 shadow-md" style="background-color: var(--dark-header);">
        <nav class="container mx-auto px-4 sm:px-6 h-24 flex justify-between items-center gap-4">
            <a href="index.html" class="flex-shrink-0">
                <img id="header-logo" src="imagens/LOGO MUSEU DO VIDEOGAME LETRAS BRANCAS (1).png" alt="Logo Museu do Videogame">
            </a>
            <a href="index.html" class="btn btn-secondary hidden sm:flex bg-gray-700 text-white border-gray-600 hover:bg-gray-600">
                <i class="fa-solid fa-arrow-left"></i><span>Voltar ao Início</span>
            </a>
        </nav>
    </header>

    <main class="flex-grow pt-12 pb-16">
        <div class="container mx-auto px-4 flex justify-center">
            <div id="quiz-container" class="w-full max-w-3xl">
                <div id="quiz-loader" class="text-center py-20">
                    <i class="fas fa-sync fa-spin text-4xl text-gray-400"></i>
                    <p class="mt-4 text-xl text-gray-600">A carregar perguntas...</p>
                </div>

                <div id="error-screen" class="hidden text-center py-20 bg-white rounded-lg shadow-md">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500"></i>
                    <h2 class="mt-4 text-2xl font-bold">Não foi possível carregar o Quiz</h2>
                    <p class="text-gray-600 mt-2">Não há perguntas suficientes no nosso banco de dados ou ocorreu um erro. Tente novamente mais tarde.</p>
                    <a href="index.html" class="btn btn-primary mt-6">Voltar à Página Inicial</a>
                </div>

                <div id="quiz-start-screen" class="hidden text-center py-10 px-6 bg-white rounded-lg shadow-md">
                    <h1 class="text-4xl font-bold" style="font-family: 'Bungee', cursive;">Desafio do Museu!</h1>
                    <p class="text-lg text-gray-600 mt-4">Teste seus conhecimentos com <strong>10 perguntas</strong> aleatórias sobre o universo dos games. Preparado?</p>
                    <button id="start-quiz-btn" class="btn btn-primary mt-8 text-lg" style="font-family: 'Press Start 2P', cursive;">Começar!</button>
                </div>

                <div id="quiz-main-box" class="hidden bg-white rounded-lg shadow-md p-6 sm:p-8">
                    <!-- Nova Barra de Progresso -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <p id="quiz-progress" class="text-sm font-semibold text-gray-500"></p>
                            <p id="current-score" class="text-sm font-semibold text-gray-500"></p>
                        </div>
                        <div id="progress-bar" class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar-inner" class="bg-yellow-400 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="question-text" class="text-xl sm:text-2xl font-bold mb-6 min-h-[6rem] flex items-center"></div>
                    <div id="options-container" class="space-y-4 mb-6"></div>
                    <div class="border-t pt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <p id="feedback-text" class="h-6 text-lg font-bold"></p>
                        <button id="action-btn" class="btn btn-primary w-full sm:w-auto">Confirmar Resposta</button>
                    </div>
                </div>

                <div id="quiz-results-screen" class="hidden text-center py-10 px-6 bg-white rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold" style="font-family: 'Bungee', cursive;">Quiz Finalizado!</h2>
                    <p id="final-score" class="text-5xl font-bold my-4 text-[var(--primary-color)]" style="font-family: 'Press Start 2P', cursive;"></p>
                    <div id="results-feedback" class="text-center">
                        <img id="result-gif" src="" alt="Resultado do Quiz" class="mx-auto h-48 w-auto mb-4 rounded-lg"/>
                        <p id="results-message" class="text-xl text-gray-700 font-semibold"></p>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
                        <button id="restart-quiz-btn" class="btn btn-primary">Jogar Novamente</button>
                        <a href="index.html" class="btn btn-secondary">Voltar ao Início</a>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="py-8 bg-gray-200 border-t border-gray-300">
        <div class="container mx-auto text-center text-gray-600">
            <p>&copy; 2025 Museu Itinerante do Videojogo. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCvngtKFRtfIJw-8ISyi5iZSvJq3jicP_4",
            authDomain: "museu-cca6d.firebaseapp.com",
            projectId: "museu-cca6d",
            storageBucket: "museu-cca6d.firebasestorage.app",
            messagingSenderId: "555107674356",
            appId: "1:555107674356:web:f38d1703d35831f7ad16a1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'museu-cca6d';

        // --- LÓGICA DO QUIZ ---
        const NUM_QUESTIONS_PER_ROUND = 10;
        let allQuestions = [];
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedOptionElement = null;

        const loader = document.getElementById('quiz-loader');
        const errorScreen = document.getElementById('error-screen');
        const startScreen = document.getElementById('quiz-start-screen');
        const mainBox = document.getElementById('quiz-main-box');
        const resultsScreen = document.getElementById('quiz-results-screen');
        const quizProgress = document.getElementById('quiz-progress');
        const currentScore = document.getElementById('current-score');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackText = document.getElementById('feedback-text');
        const actionBtn = document.getElementById('action-btn');
        const finalScore = document.getElementById('final-score');
        const resultsMessage = document.getElementById('results-message');
        const resultGif = document.getElementById('result-gif');
        const progressBarInner = document.getElementById('progress-bar-inner');

        const showQuizScreen = (screen) => {
            loader.classList.add('hidden');
            errorScreen.classList.add('hidden');
            startScreen.classList.add('hidden');
            mainBox.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            screen.classList.remove('hidden');
        };

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };
        
        const selectRandomQuestions = () => {
            currentQuizQuestions = shuffleArray([...allQuestions]).slice(0, NUM_QUESTIONS_PER_ROUND);
        };
        
        const updateProgressBar = () => {
            const progressPercentage = ((currentQuestionIndex) / currentQuizQuestions.length) * 100;
            progressBarInner.style.width = `${progressPercentage}%`;
        };

        const displayQuestion = () => {
            selectedOptionElement = null;
            const question = currentQuizQuestions[currentQuestionIndex];
            
            quizProgress.textContent = `Pergunta ${currentQuestionIndex + 1} de ${currentQuizQuestions.length}`;
            currentScore.textContent = `Pontuação: ${score}`;
            questionText.innerHTML = question.pergunta_texto;
            updateProgressBar();
            
            optionsContainer.innerHTML = '';
            shuffleArray([...question.opcoes]).forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = `<span>${option.texto}</span> <i class="feedback-icon fas fa-check text-green-500"></i><i class="feedback-icon fas fa-times text-red-500"></i>`;
                button.className = 'option-btn';
                button.dataset.correct = option.correta;
                button.addEventListener('click', () => selectAnswer(button));
                optionsContainer.appendChild(button);
            });
            
            feedbackText.textContent = '';
            actionBtn.textContent = 'Confirmar Resposta';
            actionBtn.disabled = true;
        };
        
        const selectAnswer = (button) => {
            if (selectedOptionElement) {
                selectedOptionElement.classList.remove('selected');
            }
            button.classList.add('selected');
            selectedOptionElement = button;
            actionBtn.disabled = false;
        };

        const checkAnswer = () => {
            actionBtn.disabled = true;
            Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);
            
            const isCorrect = selectedOptionElement.dataset.correct === 'true';

            if (isCorrect) {
                score++;
                selectedOptionElement.classList.add('correct');
                feedbackText.textContent = 'Correto!';
                feedbackText.style.color = 'var(--correct-color)';
            } else {
                selectedOptionElement.classList.add('wrong');
                feedbackText.textContent = 'Incorreto!';
                feedbackText.style.color = 'var(--wrong-color)';
                const correctButton = optionsContainer.querySelector('[data-correct="true"]');
                if(correctButton) correctButton.classList.add('correct');
            }
            
            currentScore.textContent = `Pontuação: ${score}`;
            
            if (currentQuestionIndex < currentQuizQuestions.length - 1) {
                actionBtn.textContent = 'Próxima Pergunta';
            } else {
                actionBtn.textContent = 'Ver Resultados';
            }
            // Atraso para o usuário ver o feedback antes de poder avançar
            setTimeout(() => { actionBtn.disabled = false; }, 800);
        };

        const showResults = () => {
            progressBarInner.style.width = '100%';
            finalScore.textContent = `${score} / ${currentQuizQuestions.length}`;
            const percentage = (score / currentQuizQuestions.length) * 100;
            
            const resultsTiers = [
                { limit: 0, msg: "Não desanime! Que tal explorar nosso acervo para aprender mais?", gif: "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3g0aXhpOTI3d3pucnNkdDRiaGJzY2N3aXczbDVpZzVoYzdqd3M0ZyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/l378t23s83ZLxv7bO/giphy.gif" },
                { limit: 40, msg: "Bom esforço! Você está no caminho certo.", gif: "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExejAybzNjcTRvZnczczZmdzNkaG02ajlpcWM0ZWN2bGI5eTJkMGl2ZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3oKIPm3BynUpUysTHW/giphy.gif" },
                { limit: 70, msg: "Excelente trabalho! Você conhece bem o assunto.", gif: "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExczBucjVqc3g5YWdlYmI3ejM5c3E3ZWp5emI4M2VmM3doZ3M4enE0diZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/a0h7sAqON67nO/giphy.gif" },
                { limit: 99, msg: "Impressionante! Você é um verdadeiro mestre dos games!", gif: "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbXN6cTN3Y2NqOGc1d2Z5bm5rZGJ0bDR1YjE5b2w3dnpwMm1jYmE5eCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/g9582DNuQppxC/giphy.gif" },
                { limit: 100, msg: "PERFEITO! Você acertou todas! Lendário!", gif: "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbzdxZzF0ZnM1Znhna3JzYnR4ZW9oM3Y1b25jZzBzbWl1enE5bTMyMyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o7WTqAduA4dCAaM24/giphy.gif" }
            ];

            const result = resultsTiers.find(tier => percentage <= tier.limit) || resultsTiers[resultsTiers.length - 1];
            resultsMessage.textContent = result.msg;
            resultGif.src = result.gif;

            showQuizScreen(resultsScreen);
        };

        const startQuiz = () => {
            currentQuestionIndex = 0;
            score = 0;
            selectRandomQuestions();
            if (currentQuizQuestions.length < NUM_QUESTIONS_PER_ROUND) {
                showQuizScreen(errorScreen);
                return;
            }
            showQuizScreen(mainBox);
            displayQuestion();
        };

        // --- LÓGICA DE INICIALIZAÇÃO ---
        const init = async () => {
            try {
                // *** CORREÇÃO APLICADA AQUI ***
                // O caminho agora aponta diretamente para o documento único do quiz.
                const quizDocRef = doc(db, `/artifacts/${appId}/public/data/quizzes/banco_de_perguntas_unico`);
                const docSnap = await getDoc(quizDocRef);

                if (docSnap.exists()) {
                    const quizData = docSnap.data();
                    if (quizData.perguntas && Array.isArray(quizData.perguntas)) {
                        allQuestions = quizData.perguntas;
                    }
                }

                if (allQuestions.length >= NUM_QUESTIONS_PER_ROUND) {
                    showQuizScreen(startScreen);
                } else {
                    console.warn(`Perguntas insuficientes. Encontradas: ${allQuestions.length}, Necessárias: ${NUM_QUESTIONS_PER_ROUND}`);
                    showQuizScreen(errorScreen);
                }
            } catch (err) {
                console.error("Erro ao buscar perguntas:", err);
                showQuizScreen(errorScreen);
            }
        };

        document.getElementById('start-quiz-btn').addEventListener('click', startQuiz);
        document.getElementById('restart-quiz-btn').addEventListener('click', startQuiz);
        actionBtn.addEventListener('click', () => {
            if (actionBtn.textContent.includes('Confirmar')) {
                checkAnswer();
            } else if (actionBtn.textContent.includes('Próxima')) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                showResults();
            }
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
