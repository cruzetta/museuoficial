<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - Museu do Videojogo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;500;700&family=Bungee&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #fde047; /* Amarelo mais vibrante */
            --primary-hover: #facc15;
            --secondary-color: #3b82f6; /* Azul */
            --dark-bg: #111827;
            --dark-card: #1f2937;
            --text-light: #d1d5db;
            --border-color: #4b5563;
            --correct-color: #34d399; 
            --wrong-color: #f87171;
        }

        body { 
            font-family: 'Press Start 2P', cursive; 
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle at 25px 25px, rgba(255,255,255,0.05) 2%, transparent 0%), radial-gradient(circle at 75px 75px, rgba(255,255,255,0.05) 2%, transparent 0%);
            background-size: 100px 100px;
            color: var(--text-light);
        }

        #header-logo { height: 100px; width: auto; }

        .btn {
            font-family: 'Press Start 2P', cursive;
            text-transform: uppercase;
            padding: 12px 24px;
            border-radius: 0;
            border: 2px solid var(--border-color);
            box-shadow: 4px 4px 0px var(--border-color);
            transition: all 0.1s ease-in-out;
        }
        .btn:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px var(--border-color);
        }
        .btn:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px var(--border-color);
        }

        .btn-primary { 
            background-color: var(--primary-color); 
            color: var(--dark-bg);
            border-color: #a16207;
            box-shadow: 4px 4px 0px #a16207;
        }
         .btn-primary:hover { box-shadow: 2px 2px 0px #a16207; }
         .btn-primary:active { box-shadow: 0px 0px 0px #a16207; }

        .btn-secondary { 
            background-color: var(--secondary-color); 
            color: white;
            border-color: #1e40af;
            box-shadow: 4px 4px 0px #1e40af;
        }
        .btn-secondary:hover { box-shadow: 2px 2px 0px #1e40af; }
        .btn-secondary:active { box-shadow: 0px 0px 0px #1e40af; }
        
        .content-box {
            background-color: var(--dark-card);
            border: 4px solid var(--border-color);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .option-btn { 
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            width: 100%; 
            text-align: left; 
            background-color: #374151; 
            border: 2px solid var(--border-color); 
            padding: 1rem;
            transition: all 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
        }
        .option-btn:hover:not(:disabled) { background-color: #4b5563; }
        .option-btn.selected { border-color: var(--primary-color); background-color: #4b5563; }
        .option-btn.correct { border-color: var(--correct-color); background-color: #10b98120; color: white; font-weight: 700; }
        .option-btn.wrong { border-color: var(--wrong-color); background-color: #ef444420; color: white; }
        .option-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .option-btn .feedback-icon { display: none; }
        .option-btn.correct .feedback-icon.fa-check, .option-btn.wrong .feedback-icon.fa-times { display: inline-block; }
        
        #progress-bar-inner { transition: width 0.3s ease-in-out; }
        
        .submission-form input[type="text"], .submission-form textarea {
            background-color: #374151;
            border: 2px solid var(--border-color);
            color: var(--text-light);
            padding: 0.75rem;
            width: 100%;
            font-family: 'Inter', sans-serif;
        }
        .submission-form input[type="text"]:focus, .submission-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .submission-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .submission-option input[type="radio"] {
            width: 1.5rem;
            height: 1.5rem;
            accent-color: var(--primary-color);
        }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <header class="sticky top-0 z-50 shadow-md" style="background-color: var(--dark-header);">
        <nav class="container mx-auto px-4 sm:px-6 h-24 flex justify-between items-center gap-4">
            <a href="index.html" class="flex-shrink-0">
                <img id="header-logo" src="imagens/LOGO MUSEU DO VIDEOGAME LETRAS BRANCAS (1).png" alt="Logo Museu do Videogame">
            </a>
            <a href="index.html" class="btn btn-secondary hidden sm:flex text-sm">
                <i class="fa-solid fa-arrow-left"></i><span>Voltar</span>
            </a>
        </nav>
    </header>

    <main class="flex-grow pt-12 pb-16">
        <div class="container mx-auto px-4 flex flex-col items-center gap-16">
            <div id="quiz-container" class="w-full max-w-3xl">
                <div id="quiz-loader" class="text-center py-20">
                    <i class="fas fa-sync fa-spin text-4xl text-gray-400"></i>
                    <p class="mt-4 text-xl">A carregar perguntas...</p>
                </div>

                <div id="error-screen" class="hidden text-center py-20 content-box">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500"></i>
                    <h2 class="mt-4 text-2xl font-bold text-white">Não foi possível carregar o Quiz</h2>
                    <p class="text-gray-400 mt-2 font-sans">Não há perguntas suficientes ou ocorreu um erro.</p>
                    <a href="index.html" class="btn btn-primary mt-6">Página Inicial</a>
                </div>

                <div id="quiz-start-screen" class="hidden text-center py-10 px-6 content-box">
                    <h1 class="text-4xl font-bold text-white" style="font-family: 'Bungee', cursive;">Desafio do Museu!</h1>
                    <p class="text-lg text-gray-300 mt-4 font-sans">Teste seus conhecimentos com <strong>10 perguntas</strong> sobre o universo dos games. Preparado?</p>
                    <button id="start-quiz-btn" class="btn btn-primary mt-8 text-lg">Começar!</button>
                </div>

                <div id="quiz-main-box" class="hidden content-box p-6 sm:p-8">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2 font-sans text-sm">
                            <p id="quiz-progress" class="font-semibold"></p>
                            <p id="current-score" class="font-semibold"></p>
                        </div>
                        <div id="progress-bar" class="w-full bg-gray-900 border-2 border-gray-600 h-4 p-0.5">
                            <div id="progress-bar-inner" class="bg-green-500 h-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="question-text" class="text-lg sm:text-xl font-bold text-white mb-2 min-h-[6rem] flex items-center justify-center text-center leading-relaxed" style="font-family: 'Inter', sans-serif;"></div>
                    <div id="question-author" class="text-right text-xs italic text-gray-400 font-sans h-4 mb-4"></div>
                    <div id="options-container" class="space-y-3 mb-6"></div>
                    <div class="border-t-2 border-dashed border-gray-600 pt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <p id="feedback-text" class="h-6 text-lg font-bold"></p>
                        <button id="action-btn" class="btn btn-primary w-full sm:w-auto text-sm">Confirmar</button>
                    </div>
                </div>

                <div id="quiz-results-screen" class="hidden text-center py-10 px-6 content-box">
                    <h2 class="text-3xl font-bold text-white" style="font-family: 'Bungee', cursive;">Quiz Finalizado!</h2>
                    <p id="final-score" class="text-5xl font-bold my-4 text-[var(--primary-color)]"></p>
                    <div id="results-feedback" class="text-center">
                        <img id="result-gif" src="" alt="Resultado do Quiz" class="mx-auto h-48 w-auto mb-4 rounded-lg"/>
                        <p id="results-message" class="text-xl text-gray-200 font-semibold font-sans"></p>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
                        <button id="restart-quiz-btn" class="btn btn-primary">Jogar Novamente</button>
                        <a href="index.html" class="btn btn-secondary">Página Inicial</a>
                    </div>
                </div>
            </div>

            <div id="submission-container" class="w-full max-w-3xl">
                <div class="content-box p-6 sm:p-8">
                    <h2 class="text-2xl sm:text-3xl font-bold text-white text-center mb-6" style="font-family: 'Bungee', cursive;">Crie uma Pergunta!</h2>
                    <p class="text-center font-sans text-gray-400 mb-8">Ajude a expandir o nosso quiz! Envie a sua pergunta e, após aprovação, ela poderá aparecer para todos.</p>
                    
                    <div id="submission-success" class="hidden text-center p-6 bg-green-900/50 border-2 border-green-500">
                        <i class="fas fa-check-circle text-4xl text-green-400"></i>
                        <h3 class="text-xl font-bold mt-4">Pergunta Enviada!</h3>
                        <p class="font-sans text-gray-300 mt-2">Obrigado pela sua contribuição! A sua pergunta foi enviada para análise.</p>
                        <button id="new-submission-btn" class="btn btn-primary mt-6 text-sm">Enviar Outra Pergunta</button>
                    </div>

                    <form id="submission-form" class="space-y-6 submission-form">
                        <div>
                            <label for="submit-name" class="font-sans font-semibold mb-2 block">Seu Nome</label>
                            <input type="text" id="submit-name" placeholder="Como devemos creditá-lo?" required>
                        </div>
                        <div>
                            <label for="submit-question" class="font-sans font-semibold mb-2 block">A sua Pergunta</label>
                            <textarea id="submit-question" rows="3" placeholder="Qual é a sua pergunta sobre o mundo dos games?" required></textarea>
                        </div>
                        <div>
                            <label class="font-sans font-semibold mb-2 block">Opções de Resposta (marque a correta)</label>
                            <div id="submission-options-container" class="space-y-3">
                            </div>
                            <button type="button" id="add-submission-option-btn" class="btn btn-secondary mt-4 text-xs">
                                <i class="fas fa-plus"></i> Adicionar Opção
                            </button>
                        </div>
                        <div class="pt-4">
                            <button type="submit" class="btn btn-primary w-full text-lg">Enviar Pergunta</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="py-8 bg-gray-900 border-t-4 border-gray-700 mt-auto">
        <div class="container mx-auto text-center text-gray-500 font-sans text-sm">
            <p>&copy; 2025 Museu Itinerante do Videojogo. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCvngtKFRtfIJw-8ISyi5iZSvJq3jicP_4",
            authDomain: "museu-cca6d.firebaseapp.com",
            projectId: "museu-cca6d",
            storageBucket: "museu-cca6d.firebasestorage.app",
            messagingSenderId: "555107674356",
            appId: "1:555107674356:web:f38d1703d35831f7ad16a1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'museu-cca6d';

        // --- LÓGICA DO QUIZ PRINCIPAL ---
        const NUM_QUESTIONS_PER_ROUND = 10;
        let allQuestions = [];
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedOptionElement = null;

        const loader = document.getElementById('quiz-loader');
        const errorScreen = document.getElementById('error-screen');
        const startScreen = document.getElementById('quiz-start-screen');
        const mainBox = document.getElementById('quiz-main-box');
        const resultsScreen = document.getElementById('quiz-results-screen');
        const quizProgress = document.getElementById('quiz-progress');
        const currentScore = document.getElementById('current-score');
        const questionText = document.getElementById('question-text');
        const questionAuthor = document.getElementById('question-author');
        const optionsContainer = document.getElementById('options-container');
        const feedbackText = document.getElementById('feedback-text');
        const actionBtn = document.getElementById('action-btn');
        const finalScore = document.getElementById('final-score');
        const resultsMessage = document.getElementById('results-message');
        const resultGif = document.getElementById('result-gif');
        const progressBarInner = document.getElementById('progress-bar-inner');

        const showQuizScreen = (screen) => {
            loader.classList.add('hidden');
            errorScreen.classList.add('hidden');
            startScreen.classList.add('hidden');
            mainBox.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            screen.classList.remove('hidden');
        };

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };
        
        const selectRandomQuestions = () => {
            currentQuizQuestions = shuffleArray([...allQuestions]).slice(0, NUM_QUESTIONS_PER_ROUND);
        };
        
        const updateProgressBar = () => {
            const progressPercentage = ((currentQuestionIndex) / currentQuizQuestions.length) * 100;
            progressBarInner.style.width = `${progressPercentage}%`;
        };

        const displayQuestion = () => {
            selectedOptionElement = null;
            const question = currentQuizQuestions[currentQuestionIndex];
            
            quizProgress.textContent = `Pergunta ${currentQuestionIndex + 1} / ${currentQuizQuestions.length}`;
            currentScore.textContent = `Pontos: ${score}`;
            questionText.innerHTML = question.pergunta_texto;
            
            // NOVO: Exibe o autor se existir
            if (question.autor) {
                questionAuthor.textContent = `Pergunta criada por: ${question.autor}`;
            } else {
                questionAuthor.textContent = '';
            }

            updateProgressBar();
            
            optionsContainer.innerHTML = '';
            shuffleArray([...question.opcoes]).forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = `<span>${option.texto}</span> <i class="feedback-icon fas fa-check text-green-400"></i><i class="feedback-icon fas fa-times text-red-400"></i>`;
                button.className = 'option-btn';
                button.dataset.correct = option.correta;
                button.addEventListener('click', () => selectAnswer(button));
                optionsContainer.appendChild(button);
            });
            
            feedbackText.textContent = '';
            actionBtn.textContent = 'Confirmar';
            actionBtn.disabled = true;
        };
        
        const selectAnswer = (button) => {
            if (selectedOptionElement) {
                selectedOptionElement.classList.remove('selected');
            }
            button.classList.add('selected');
            selectedOptionElement = button;
            actionBtn.disabled = false;
        };

        const checkAnswer = () => {
            actionBtn.disabled = true;
            Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);
            
            const isCorrect = selectedOptionElement.dataset.correct === 'true';

            if (isCorrect) {
                score++;
                selectedOptionElement.classList.add('correct');
                feedbackText.textContent = 'Correto!';
                feedbackText.style.color = 'var(--correct-color)';
            } else {
                selectedOptionElement.classList.add('wrong');
                feedbackText.textContent = 'Incorreto!';
                feedbackText.style.color = 'var(--wrong-color)';
                const correctButton = optionsContainer.querySelector('[data-correct="true"]');
                if(correctButton) correctButton.classList.add('correct');
            }
            
            currentScore.textContent = `Pontos: ${score}`;
            
            if (currentQuestionIndex < currentQuizQuestions.length - 1) {
                actionBtn.textContent = 'Próxima';
            } else {
                actionBtn.textContent = 'Resultados';
            }
            setTimeout(() => { actionBtn.disabled = false; }, 1000);
        };

        const showResults = () => {
            progressBarInner.style.width = '100%';
            finalScore.textContent = `${score} / ${currentQuizQuestions.length}`;
            const percentage = (score / currentQuizQuestions.length) * 100;
            
            const resultsTiers = [
                { limit: 0, msg: "Não desanime! Que tal explorar nosso acervo para aprender mais?", gif: "https://media.giphy.com/media/27EhcDHnlkw1O/giphy.gif" },
                { limit: 40, msg: "Bom esforço! Você está no caminho certo.", gif: "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExejAybzNjcTRvZnczczZmdzNkaG02ajlpcWM0ZWN2bGI5eTJkMGl2ZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3oKIPm3BynUpUysTHW/giphy.gif" },
                { limit: 70, msg: "Excelente trabalho! Você conhece bem o assunto.", gif: "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExczBucjVqc3g5YWdlYmI3ejM5c3E3ZWp5emI4M2VmM3doZ3M4enE0diZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/a0h7sAqON67nO/giphy.gif" },
                { limit: 99, msg: "Impressionante! Você é um verdadeiro mestre dos games!", gif: "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbXN6cTN3Y2NqOGc1d2Z5bm5rZGJ0bDR1YjE5b2w3dnpwMm1jYmE5eCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/g9582DNuQppxC/giphy.gif" },
                { limit: 100, msg: "PERFEITO! Você acertou todas! Lendário!", gif: "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExZ3N2bWd2Z2d2bzBqZGc1dWw2b3JtY2w0bW12bDU1dG82eWd2a2gyZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/5VKbvrjxpVJCM/giphy.gif" }
            ];

            const result = resultsTiers.find(tier => percentage <= tier.limit) || resultsTiers[resultsTiers.length - 1];
            resultsMessage.textContent = result.msg;
            resultGif.src = result.gif;

            showQuizScreen(resultsScreen);
        };

        const startQuiz = () => {
            currentQuestionIndex = 0;
            score = 0;
            selectRandomQuestions();
            if (currentQuizQuestions.length < NUM_QUESTIONS_PER_ROUND) {
                showQuizScreen(errorScreen);
                return;
            }
            showQuizScreen(mainBox);
            displayQuestion();
        };

        const initQuiz = async () => {
            try {
                const quizDocRef = doc(db, `/artifacts/${appId}/public/data/quizzes/banco_de_perguntas_unico`);
                const docSnap = await getDoc(quizDocRef);

                if (docSnap.exists()) {
                    const quizData = docSnap.data();
                    if (quizData.perguntas && Array.isArray(quizData.perguntas)) {
                        allQuestions = quizData.perguntas;
                    }
                }

                if (allQuestions.length >= NUM_QUESTIONS_PER_ROUND) {
                    showQuizScreen(startScreen);
                } else {
                    console.warn(`Perguntas insuficientes. Encontradas: ${allQuestions.length}, Necessárias: ${NUM_QUESTIONS_PER_ROUND}`);
                    showQuizScreen(errorScreen);
                }
            } catch (err) {
                console.error("Erro ao buscar perguntas:", err);
                showQuizScreen(errorScreen);
            }
        };

        document.getElementById('start-quiz-btn').addEventListener('click', startQuiz);
        document.getElementById('restart-quiz-btn').addEventListener('click', startQuiz);
        actionBtn.addEventListener('click', () => {
            const actionText = actionBtn.textContent;
            if (actionText.includes('Confirmar')) {
                checkAnswer();
            } else if (actionText.includes('Próxima')) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                showResults();
            }
        });

        // --- LÓGICA DO FORMULÁRIO DE SUBMISSÃO ---
        const submissionForm = document.getElementById('submission-form');
        const submissionOptionsContainer = document.getElementById('submission-options-container');
        const addSubmissionOptionBtn = document.getElementById('add-submission-option-btn');
        const submissionSuccessDiv = document.getElementById('submission-success');
        const newSubmissionBtn = document.getElementById('new-submission-btn');

        const addSubmissionOption = (isFirst = false) => {
            const optionCount = submissionOptionsContainer.children.length;
            const div = document.createElement('div');
            div.className = 'submission-option';
            div.innerHTML = `
                <input type="radio" name="correct-submission-option" value="${optionCount}" ${isFirst ? 'checked' : ''} required>
                <input type="text" placeholder="Texto da alternativa ${optionCount + 1}" required>
                <button type="button" class="btn btn-secondary !p-2 !text-xs remove-option-btn ${optionCount < 2 ? 'hidden' : ''}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            submissionOptionsContainer.appendChild(div);
            div.querySelector('.remove-option-btn').addEventListener('click', () => {
                div.remove();
                if (!submissionOptionsContainer.querySelector('input[type="radio"]:checked') && submissionOptionsContainer.children.length > 0) {
                    submissionOptionsContainer.querySelector('input[type="radio"]').checked = true;
                }
            });
        };

        addSubmissionOptionBtn.addEventListener('click', () => addSubmissionOption());

        submissionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = submissionForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = "A enviar...";

            const name = document.getElementById('submit-name').value.trim();
            const questionText = document.getElementById('submit-question').value.trim();
            const options = [];
            const optionElements = submissionOptionsContainer.querySelectorAll('.submission-option');
            const correctIndex = submissionForm.querySelector('input[name="correct-submission-option"]:checked').value;

            optionElements.forEach((opt, index) => {
                const text = opt.querySelector('input[type="text"]').value.trim();
                if (text) {
                    options.push({
                        texto: text,
                        correta: index == correctIndex
                    });
                }
            });

            if (options.length < 2) {
                alert("Por favor, forneça pelo menos duas opções de resposta.");
                submitButton.disabled = false;
                submitButton.textContent = "Enviar Pergunta";
                return;
            }

            try {
                const submissionData = {
                    autor: name,
                    pergunta_texto: questionText,
                    opcoes: options,
                    status: 'pendente',
                    dataEnvio: new Date()
                };
                await addDoc(collection(db, `/artifacts/${appId}/public/data/quiz_submissions`), submissionData);
                
                submissionForm.classList.add('hidden');
                submissionSuccessDiv.classList.remove('hidden');

            } catch (error) {
                console.error("Erro ao enviar pergunta: ", error);
                alert("Ocorreu um erro ao enviar a sua pergunta. Tente novamente.");
                submitButton.disabled = false;
                submitButton.textContent = "Enviar Pergunta";
            }
        });

        newSubmissionBtn.addEventListener('click', () => {
             submissionForm.reset();
             submissionOptionsContainer.innerHTML = '';
             addSubmissionOption(true);
             addSubmissionOption();
             submissionForm.querySelector('button[type="submit"]').disabled = false;
             submissionForm.querySelector('button[type="submit"]').textContent = "Enviar Pergunta";
             submissionSuccessDiv.classList.add('hidden');
             submissionForm.classList.remove('hidden');
        });


        // --- INICIALIZAÇÃO GERAL ---
        document.addEventListener('DOMContentLoaded', () => {
            initQuiz();
            addSubmissionOption(true);
            addSubmissionOption();
        });
    </script>
</body>
</html>
